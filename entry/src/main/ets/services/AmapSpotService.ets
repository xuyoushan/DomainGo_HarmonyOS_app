import { http } from '@kit.NetworkKit';

interface AmapPhoto {
  url: string;
}

interface AmapBizExt {
  rating: string;
  cost: string;
}

interface AmapPoi {
  id: string;
  name: string;
  type: string;
  address: string;
  distance: string;
  photos: AmapPhoto[];
  biz_ext: AmapBizExt;
}

interface AmapResponse {
  status: string;
  pois: AmapPoi[];
}

export interface ScenicSpot {
  id: string;
  name: string;
  image: string;
  rating: string;
  price: string;
  isFree: boolean;
  distance: number;
  address: string;
  tags: string[];
  isMuseum: boolean;
}

export class AmapSpotService {
  private static readonly API_KEY = 'd4552bc3e20af2857f9cfd5ac95ded1d';

  // ğŸ”¹ åœºé¦†å·²å•ç‹¬é€‚é…çš„â€œè¶…å¤§åŸå¸‚â€
  private static readonly VENUE_EXCLUDED_CITIES = [
    'åŒ—äº¬',
    'å¤©æ´¥',
    'ä¸Šæµ·',
    'æ­¦æ±‰',
    'é‡åº†',
    'æˆéƒ½'
  ];

  private static readonly CITY_CORE_LANDMARKS: Map<string, RegExp> = new Map([
    ['åŒ—äº¬', /æ•…å®«|å¤©å®‰é—¨|é¢å’Œå›­|å¤©å›|é•¿åŸ|åœ†æ˜å›­/],
    ['å¤©æ´¥', /å¤æ–‡åŒ–è¡—|æ„å¼é£æƒ…åŒº|äº”å¤§é“/],
    ['ä¸Šæµ·', /å¤–æ»©|ä¸œæ–¹æ˜ç |è±«å›­|å—äº¬è·¯/],
    ['æ­¦æ±‰', /é»„é¹¤æ¥¼|ä¸œæ¹–|æ­¦æ±‰é•¿æ±Ÿå¤§æ¡¥|æ±‰å£æ±Ÿæ»©/],
    ['é‡åº†', /æ´ªå´–æ´|è§£æ”¾ç¢‘|ç£å™¨å£|æœå¤©é—¨/],
    ['æˆéƒ½', /å®½çª„å··å­|é”¦é‡Œ|éƒ½æ±Ÿå °|é’åŸå±±/]
  ]);

  static async fetchSpots(city: string): Promise<ScenicSpot[]> {
    const key = AmapSpotService.API_KEY;
    // ğŸ”¹ ä¼˜åŒ–1ï¼šæ‰©å……æœç´¢ç±»å‹ï¼Œå¢åŠ  110000(é£æ™¯åèƒœ) å’Œ 140000(æ–‡åŒ–åœºé¦†)
    const keywords = encodeURIComponent('æ™¯åŒº|åœ°æ ‡|å…¬å›­|åšç‰©é¦†');
    const types = '110000|140000';

    const url = `https://restapi.amap.com/v3/place/text?key=${key}&keywords=${keywords}&types=${types}&city=${encodeURIComponent(
      city
    )}&offset=50&page=1&extensions=all&sortrule=weight`;

    const httpRequest = http.createHttp();

    try {
      const response = await httpRequest.request(url);
      if (response.responseCode !== 200) return [];

      const result = JSON.parse(response.result as string) as AmapResponse;
      if (result.status !== '1' || !result.pois) return [];

      const coreRegex = AmapSpotService.CITY_CORE_LANDMARKS.get(city);
      const finalPois: AmapPoi[] = [];

      result.pois.forEach((poi) => {
        const name = poi.name || '';

        // ğŸ”¹ ä¼˜åŒ–2ï¼šæ ¸å¿ƒåœ°æ ‡å…·æœ‰â€œæœ€é«˜è±å…æƒâ€ï¼Œä¸å‚ä¸ä»»ä½•é»‘åå•è¿‡æ»¤
        if (coreRegex && coreRegex.test(name)) {
          finalPois.push(poi);
          return;
        }

        // ğŸ”¹ ä¼˜åŒ–3ï¼šé»‘åå•é€»è¾‘ç²¾å‡†åŒ–ã€‚
        // åªæ’é™¤å•çº¯çš„è®¾æ–½ï¼Œå¦‚æœåå­—é‡ŒåŒ…å«â€œæ™¯åŒºâ€æˆ–â€œå…¬å›­â€åˆ™ä¿ç•™ï¼ˆé˜²æ­¢è¯¯æ€â€œXXå…¬å›­å”®ç¥¨å¤„â€è¿™ç§å”¯ä¸€çš„å…¥å£ç‚¹ï¼‰
        const isInfrastructure = /(åœè½¦åœº|å•æ‰€|å‡ºå…¥å£|æœåŠ¡åŒº|ç å¤´|ç«™)$/.test(name);
        if (isInfrastructure) return;

        const rating = parseFloat(poi.biz_ext?.rating || '0');
        const photos = poi.photos || [];

        // ğŸ”¹ ä¼˜åŒ–4ï¼šæ”¾å®½é—¨æ§›ï¼Œåªè¦æœ‰å›¾æˆ–è€…è¯„åˆ†åŠæ ¼ï¼ˆ>3.5ï¼‰å°±æ”¶å½•
        if (rating > 3.5 || photos.length > 0) {
          finalPois.push(poi);
        }
      });

      // ğŸ”¹ ä¼˜åŒ–5ï¼šå»é‡æ’åºï¼Œç¡®ä¿æ ¸å¿ƒåœ°æ ‡æ’åœ¨æœ€å‰é¢
      const uniquePois = Array.from(new Set(finalPois));

      return uniquePois.map((poi): ScenicSpot => {
        const photos = poi.photos || [];
        let image = '';
        if (photos.length > 0) {
          // è¿™é‡Œçš„ç­–ç•¥å¾ˆå¥½ï¼šå–ä¸­é—´çš„å›¾é€šå¸¸æ¯”ç¬¬ä¸€å¼ é—¨å£å›¾å¥½çœ‹
          const index = Math.floor(photos.length / 2);
          image = photos[index]?.url || photos[0].url;
        }

        const costValue = poi.biz_ext?.cost || '0';

        return {
          id: poi.id,
          name: poi.name,
          image: image.replace('http:', 'https:'), // è¡¥å…¨å®‰å…¨åè®®
          rating: poi.biz_ext?.rating || '4.0',
          price: (costValue === '[]' || !costValue) ? '0' : costValue,
          isFree: parseInt(costValue) === 0 || costValue === '' || costValue === '[]',
          distance: parseInt(poi.distance || '0'),
          address: poi.address,
          tags: AmapSpotService.parseProTags(poi),
          isMuseum: /(åšç‰©é¦†|ç¾æœ¯é¦†|çºªå¿µé¦†)/.test(poi.name)
        };
      });
    } catch (e) {
      console.error('Fetch Scenic Data Failed', e);
    }
    return [];
  }

  private static parseProTags(poi: AmapPoi): string[] {
    const tags: string[] = [];
    const name = poi.name || '';
    const typeStr = poi.type || '';

    if (typeStr.includes('5A')) tags.push('5Aæ™¯åŒº');
    else if (typeStr.includes('4A')) tags.push('4Aæ™¯åŒº');
    else if (typeStr.includes('3A')) tags.push('3Aæ™¯åŒº');

    const natureRegex = /å±±|æ¹–|æµ·|å²›|æ—|å³°|æ³‰|æ»©|ç€‘|è‰åŸ/;
    if (natureRegex.test(name) || typeStr.includes('è‡ªç„¶')) {
      tags.push('è‡ªç„¶');
    } else {
      tags.push('äººæ–‡');
    }

    if (parseInt(poi.biz_ext?.cost || '0') === 0) {
      tags.push('å…è´¹');
    }

    return tags.slice(0, 3);
  }
}