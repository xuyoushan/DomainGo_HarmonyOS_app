import { LocationManager } from '../../services/LocationManager';
import { common } from '@kit.AbilityKit';
import http from '@ohos.net.http';
import { PROVINCE_CITY_DATA } from '../../models/CityData';
import { CITY_BANNER_CONFIG, CityBanner } from '../../models/CityBannerData';
import { promptAction, router } from '@kit.ArkUI';
import { CITY_ROUTES, TravelRoute } from '../../models/RouteData';
import { CITY_EXPLORE_MAP, DEFAULT_EXPLORE_DATA, CityExploreConfig } from '../../models/ExploreCityData';
import { display } from '@kit.ArkUI';

interface WeatherNow { temperature: string; text: string; }
interface WeatherResult { now: WeatherNow; }
interface WeatherResponse { results: WeatherResult[]; }
interface HotTopic { title: string; color: string; count: string; }
interface TopicTemplate { suffix: string; color: string; }
interface MyNewsResponse { code: number; city: string; news: string[]; }
interface ExploreGuideParams { skipGuide?: boolean }

@Component
export struct ExploreView {
  @StorageLink('currentCity') currentCity: string = 'æ­¦æ±‰å¸‚';
  @StorageLink('currentWeather') weatherInfo: string = '...';
  @State weatherText: string = 'é˜´';
  @State searchText: string = '';
  @State scaleValue: number = 1.0; // ç”¨äºç¼©æ”¾åŠ¨ç”»
  @State bannerHeight: number = 200;
  @State hotTopics: HotTopic[] = [];
  @State newsList: string[] = ["æ­£åœ¨è¿æ¥æ–‡æ—…å¤§æ•°æ®ä¸­å¿ƒ..."]; // åˆå§‹æ–‡æ¡ˆ
  @State isCitySwitching: boolean = false
  // ------------------ æ–°å¢ï¼šå¼•å¯¼æµè½¬å…¨é‡çŠ¶æ€ (ExploreGuideWrapper è¿ç§») ------------------
  @State currentStage: 'welcome' | 'stepGuide' | 'teaching' | 'full' = 'welcome'
  @State guideStepIndex: number = 0
  @State displayedText: string = ''     // å½“å‰é€å­—æ˜¾ç¤ºçš„æ–‡æ¡ˆ
  @State isTyping: boolean = false      // æ˜¯å¦æ­£åœ¨é€å­—æ’­æ”¾
  private timerId: number = -1          // è¡¥å…¨å®šæ—¶å™¨IDå£°æ˜


  private context = getContext(this) as common.UIAbilityContext;

  private getGuideSteps(): string[] {
    return [
      `æ¬¢è¿æ¥åˆ°å¯»åŸŸä¹‹æ—…ã€‚\nåœ¨è¿™åº§åŸå¸‚ï¼Œæ¯æ¡è¡—é“ã€æ¯å¹¢å»ºç­‘ã€æ¯ä¸ªäººçš„ç¬‘å£°é‡Œï¼Œéƒ½è—ç€ç‹¬ç‰¹çš„æ•…äº‹ã€‚`,
      `è¿™é‡Œæœ‰è¢«æ—¶é—´é—å¿˜çš„è€å··ï¼Œæœ‰è¢«è®°å¿†é“­åˆ»çš„å†å²å»ºç­‘ã€‚\nèµ°è¿›å»ï¼Œä½ ä¼šå‘ç°é‚£äº›å¹³å‡¡è§’è½é‡Œéå‡¡çš„ç§˜å¯†ã€‚`,
      `åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥æ…¢æ…¢å“å‘³åŸå¸‚çš„å‘³é“ã€‚\næ— è®ºæ˜¯è¡—å¤´å°åƒçš„é¦™æ°”ï¼Œè¿˜æ˜¯è€èŒ¶é¦†é‡Œçš„è°ˆç¬‘å£°ï¼Œéƒ½åœ¨è®²è¿°å±äºåŸå¸‚çš„æ¸©åº¦ã€‚`,
      `æ¯ä¸€åº§åŸå¸‚éƒ½æœ‰è‡ªå·±çš„èŠ‚å¥å’Œè„‰ç»œã€‚\nå†å²ã€æ–‡åŒ–ã€ç”Ÿæ´»åœ¨è¿™é‡Œäº¤ç»‡ï¼Œæ¯ä¸€æ­¥è¡Œèµ°ï¼Œéƒ½æ˜¯ä¸€æ¬¡æ–°çš„å‘ç°ã€‚`,
      `å‡†å¤‡å¥½äº†å—ï¼Ÿ\nè®©æˆ‘ä»¬ä»è¿™é‡Œå¼€å§‹ï¼Œæ…¢æ…¢è§¦æ‘¸åŸå¸‚çš„æ•…äº‹ã€‚\nä¸€åœºæ¢ç´¢ä¹‹æ—…å³å°†åœ¨ä½ çš„æŒ‡å°–å±•å¼€ã€‚`,
      `ç‚¹å‡»â€œå¼€å§‹æ¢ç´¢â€ï¼Œ\nä½ å°†è¿›å…¥åŸå¸‚æ•™å­¦æ¨¡å¼ï¼Œäº†è§£æ¯ä¸ªåŠŸèƒ½ã€æ¯æ¡è·¯çº¿ã€æ¯ä¸ªæ•…äº‹çš„ç²¾åã€‚`
    ];
  }

  private playStepText() {
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }

    const steps = this.getGuideSteps()

    this.displayedText = '';
    this.isTyping = true;
    const fullText = steps[this.guideStepIndex];
    let i = 0;

    this.timerId = setInterval(() => {
      if (i < fullText.length) {
        this.displayedText += fullText[i];
        i++;
      } else {
        clearInterval(this.timerId);
        this.timerId = -1;
        this.isTyping = false;
      }
    }, 50);
  }

  private nextStep(total: number) {
    if (this.isTyping) return;
    if (this.guideStepIndex < total - 1) {
      this.guideStepIndex++;
      this.playStepText();
    } else {
      this.currentStage = 'teaching';
    }
  }

  getCityConfig(): CityExploreConfig {
    return CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
  }

  aboutToAppear() {
    const params = router.getParams() as ExploreGuideParams

    if (params?.skipGuide === true) {
      this.currentStage = 'full'
      return
    }
    // åœ¨ç”Ÿå‘½å‘¨æœŸä¸­è®¡ç®—ä¸€æ¬¡é«˜åº¦ï¼Œè€Œä¸æ˜¯åœ¨ build ä¸­å®æ—¶è®¡ç®—
    try {
      const displayData: display.Display = display.getDefaultDisplaySync();
      const screenWidthVp = px2vp(displayData.width);
      this.bannerHeight = screenWidthVp * 9 / 16;
    } catch (e) {
      this.bannerHeight = 200; // å…œåº•é«˜åº¦
    }
  }

  onPageShow() {
    this.initLocation()
    this.fetchRealNews()
  }

  aboutToDisappear() {
    if (this.timerId !== -1) {
      clearInterval(this.timerId)
      this.timerId = -1
    }
  }


  async initLocation() {
    try {
      const isAuth = await LocationManager.requestPermission(this.context)
      if (isAuth) {
        const city = await LocationManager.getRealCity(this.context)
        if (city && city !== 'å®šä½å¤±è´¥') {
          this.updateCityState(city);
        }
      } else {
        this.fetchRealWeather(this.currentCity)
      }
    } catch (err) {
      this.fetchRealWeather(this.currentCity)
    }
  }

  private async updateCityState(city: string) {
    if (city === this.currentCity) return

    this.isCitySwitching = true
    this.currentCity = city
    AppStorage.setOrCreate('currentCity', city)

    // ç»™äººç±»ä¸€ç‚¹â€œç³»ç»Ÿååº”æ—¶é—´â€
    await new Promise<void>((resolve) => {
      setTimeout(() => {
        resolve()
      }, 500)
    })

    await Promise.all([
      this.fetchRealWeather(city),
      this.fetchRealNews(),
      this.fetchHotTopics()
    ])

    this.isCitySwitching = false
    console.info(`[Explore] åŸå¸‚åˆ‡æ¢å®Œæˆ: ${city}`)
  }

  showCityPicker() {
    let provinces = Object.keys(PROVINCE_CITY_DATA);
    TextPickerDialog.show({
      range: provinces,
      onAccept: (pResult: TextPickerResult) => {
        let cities = PROVINCE_CITY_DATA[pResult.value as string];
        setTimeout(() => {
          TextPickerDialog.show({
            range: cities,
            onAccept: (cResult: TextPickerResult) => {
              this.updateCityState(cResult.value as string);
            }
          })
        }, 300)
      }
    })
  }

  async fetchRealWeather(city: string) {
    let httpRequest = http.createHttp();
    try {
      let queryCity = city.replace('å¸‚', '');
      let url = `https://api.seniverse.com/v3/weather/now.json?key=S7zKUHHMAcavQT0_R&location=${encodeURIComponent(queryCity)}&language=zh-Hans&unit=c`;
      let response = await httpRequest.request(url, { connectTimeout: 5000 });
      if (response.responseCode === 200) {
        let result = JSON.parse(response.result as string) as WeatherResponse;
        if (result.results?.length > 0) {
          let nowData = result.results[0].now;
          this.weatherInfo = `${nowData.temperature}Â°C`;
          this.weatherText = nowData.text;
        }
      }
    } catch (err) {
      this.weatherInfo = 'ç½‘ç»œå¼‚å¸¸';
    } finally {
      httpRequest.destroy();
    }
  }

  async fetchRealNews() {
    // --- ğŸ’¡ æ–¹æ¡ˆå¼€å…³ ---
    const USE_REAL_CRAWLER = true;  // æ¨¡å¼Aï¼šåç«¯æŠ“å–ï¼ˆåšPPT/å½•è§†é¢‘æ—¶å¼€å¯ï¼‰
    // const USE_REAL_CRAWLER = false; // æ¨¡å¼Bï¼šæœ¬åœ°æ•°æ®ï¼ˆç°åœºæ¼”ç¤º/æäº¤ä»£ç æ—¶å¼€å¯ï¼‰
    // ----------------

    if (!USE_REAL_CRAWLER) {
      // ã€æ–¹æ¡ˆäºŒï¼šè°ƒç”¨æœ¬åœ°æ•°æ®ã€‘â€”â€” æ¨¡æ‹Ÿä¸€ä¸ªåŠ è½½è¿‡ç¨‹ï¼Œæ˜¾å¾—æ›´çœŸå®
      this.newsList = ["æ­£åœ¨è¿æ¥æ–‡æ—…æ•°æ®ä¸­å¿ƒ...", "æ­£åœ¨åŒæ­¥åŸå¸‚å¿«æŠ¥..."];
      setTimeout(() => {
        this.showLocalNews();
        console.info("å·²åŠ è½½æœ¬åœ°ç²¾å“æ–‡æ—…æ•°æ®");
      }, 800); // æ•…æ„å»¶è¿Ÿ 0.8sï¼Œåšå‡ºâ€œè¯·æ±‚â€çš„è§†è§‰æ•ˆæœ
      return;
    }

    // ã€æ–¹æ¡ˆä¸€ï¼šåç«¯æŠ“å–æ¨¡å¼ã€‘â€”â€” ä»…åœ¨å¼€å¯æ¨¡å¼Aæ—¶æ‰§è¡Œ
    let isFinished = false;
    setTimeout(() => {
      if (!isFinished) {
        this.showLocalNews();
        isFinished = true;
      }
    }, 3000);

    let httpRequest = http.createHttp();
    // æ³¨æ„ï¼šè¿™é‡Œè®°å¾—æ¢æˆä½ çœŸå®çš„ç”µè„‘IP
    const url = `http://192.168.103.83:5000/get_news/${encodeURIComponent(this.currentCity)}`;
    try {
      let response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: 4000,
        expectDataType: http.HttpDataType.OBJECT
      });

      const res = response.result as MyNewsResponse;
      const localData = CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;

      if (!isFinished && res.code === 200 && res.news.length > 0) {
        const realPart = res.news.slice(0, 3);
        const localPart = localData.news.slice(0, 3);
        this.newsList = realPart.concat(localPart).sort(() => Math.random() - 0.5);
        isFinished = true;
      }
    } catch (err) {
      if (!isFinished) {
        this.showLocalNews();
        isFinished = true;
      }
    } finally {
      httpRequest.destroy();
    }
  }

  // ç»Ÿä¸€çš„æœ¬åœ°æ•°æ®è°ƒç”¨æ–¹æ³•
  showLocalNews() {
    const localData = CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
    // éšæœºæ‰“ä¹±ä¸€ä¸‹ï¼Œæ¯æ¬¡è¿›æ¥é¡ºåºä¸ä¸€æ ·ï¼Œæ˜¾å¾—æ˜¯å®æ—¶æ‹‰å–çš„
    this.newsList = [...localData.news].sort(() => Math.random() - 0.5);
  }


  async fetchHotTopics() {
    // åŒæ ·ä½¿ç”¨å…œåº•æ•°æ®è·å–å…³é”®è¯
    const config = CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
    const localKeywords = config.keywords;
    const city = this.currentCity.replace('å¸‚', '');

    // åˆšæ‰å®šä¹‰çš„å¼ºç±»å‹æ¨¡æ¿
    const topicTemplates: TopicTemplate[] = [
      { suffix: 'æ·±åº¦æ¸¸æ”»ç•¥', color: '#FFEAA7' },
      { suffix: 'åœ°åèƒŒåçš„æ•…äº‹', color: '#81ECEC' },
      { suffix: 'å®è—æ‰“å¡åœ°åˆ†äº«', color: '#FAB1A0' },
      { suffix: 'ç‰¹è‰²ç¾é£Ÿé¿é›·', color: '#D6E4FF' },
      { suffix: 'å†å²å»ºç­‘æ¼«æ­¥', color: '#E8F5E9' }
    ];

    // æ˜ å°„æˆ HotTopic æ•°ç»„
    this.hotTopics = localKeywords.slice(0, 5).map((key: string, index: number): HotTopic => {
      return {
        title: `${city}${key}${topicTemplates[index].suffix}`,
        color: topicTemplates[index].color,
        count: `${(Math.random() * 5 + 1).toFixed(1)}w`
      };
    });
  }

  getWeatherIcon(text: string): Resource {
    if (text.includes('æ™´')) return $r('sys.symbol.sun_max_fill');
    if (text.includes('é›¨')) return $r('sys.symbol.light_rain');
    if (text.includes('é˜´') || text.includes('å¤šäº‘')) return $r('sys.symbol.cloud_fill');
    return $r('sys.symbol.cloud_sun_fill');
  }

  build() {
    Stack() {
      // 1. èƒŒæ™¯å±‚
      if (this.currentStage === 'welcome' || this.currentStage === 'stepGuide') {
        this.BackgroundAtmosphere()
      }

      // 2. å†…å®¹å±‚ (ä¿®æ­£ï¼šwidth/height/alignItems ä»å‚æ•°ç§»è‡³é“¾å¼è°ƒç”¨)
      Column() {
        // ç¬¬ä¸€é˜¶æ®µï¼šæ¬¢è¿é¡µ
        if (this.currentStage === 'welcome') {
          Stack() {
            // 1. èƒŒæ™¯å¤§å›¾ï¼ˆåˆ©ç”¨ä½ ç°æœ‰çš„èµ„æºï¼Œä¸åŠ æ¨¡ç³Šï¼Œä¿æŒæ¸…æ™°æ„Ÿï¼‰
            Image($r('app.media.start'))
              .width('100%')
              .height('100%')
              .objectFit(ImageFit.Cover)

            // 2. æ¸å˜é®ç½©ï¼Œè®©åº•éƒ¨æ–‡å­—æµ®ç°
            Column()
              .width('100%')
              .height('100%')
              .linearGradient({
                direction: GradientDirection.Bottom,
                colors: [['#20000000', 0.0], ['#80000000', 1.0]]
              })

            // 3. æ–‡å­—ä¸å…¥å£
            Column() {
              // åŸå¸‚æ ‡è¯­
              Text('å¯» Â· åŸŸ')
                .fontSize(48)
                .fontWeight(FontWeight.Lighter)
                .fontColor(Color.White)
                .letterSpacing(15) // å¢åŠ å­—é—´è·ï¼Œæ›´æœ‰è‰ºæœ¯æ„Ÿ
                .margin({ bottom: 10 })

              Text('â€”â€” è§¦æ‘¸æ¯ä¸€åº§åŸå¸‚çš„æ¸©åº¦ â€”â€”')
                .fontSize(14)
                .fontColor('#CCFFFFFF')
                .letterSpacing(2)
                .margin({ bottom: 80 })

              // æ¢ç´¢å…¥å£
              Button() {
                Row({ space: 8 }) {
                  Text('å¼€å¯æ—…ç¨‹').fontColor(Color.White).fontSize(16).fontWeight(FontWeight.Medium)
                  SymbolGlyph($r('sys.symbol.arrow_right')).fontSize(18).fontColor([Color.White])
                }
              }
              .width(200)
              .height(56)
              .backgroundColor('rgba(255,255,255,0.15)') // æç®€åŠé€æ˜èƒŒæ™¯
              .backgroundBlurStyle(BlurStyle.Thin)      // åŠ ä¸Šæ¯›ç»ç’ƒæ•ˆæœ
              .borderRadius(28)
              .border({ width: 1, color: 'rgba(255,255,255,0.3)' }) // ç»†è¾¹æ¡†è´¨æ„Ÿ
              .onClick(() => {
                this.currentStage = 'stepGuide'
                this.guideStepIndex = 0
                this.playStepText()
              })
            }
            .width('100%')
            .padding({ bottom: 100 })
            .alignItems(HorizontalAlign.Center)
            .justifyContent(FlexAlign.End) // å†…å®¹æ²‰åœ¨åº•éƒ¨ï¼Œæ›´æœ‰æ„å¢ƒ
          }
          .width('100%')
          .height('100%')
        }

        // ç¬¬äºŒé˜¶æ®µï¼šåˆ†æ­¥æ–‡æ¡ˆå¼•å¯¼
        else if (this.currentStage === 'stepGuide') {
          Stack() {
            Column() {
              Text(this.displayedText).fontSize(20).fontColor(Color.White).lineHeight(28).textAlign(TextAlign.Center).margin({ left: 24, right: 24, bottom: 30 })
              if (!this.isTyping) {
                Button(this.guideStepIndex < this.getGuideSteps().length - 1 ? 'ä¸‹ä¸€æ­¥' : 'å¼€å§‹æ¢ç´¢')
                  .width(180).height(44).backgroundColor('#FF7F50').fontColor('#333').borderRadius(22)
                  .onClick(() => this.nextStep(this.getGuideSteps().length))
              }
            }
            .alignItems(HorizontalAlign.Center)
            .justifyContent(FlexAlign.Center)
            .width('100%')
            .height('100%')
            .onClick(() => this.nextStep(this.getGuideSteps().length))
          }
          .width('100%')
          .height('100%')
        }

        // ç¬¬ä¸‰é˜¶æ®µï¼šæ•™å­¦æ€
        else if (this.currentStage === 'teaching') {
          Column({ space: 20 }) {
            Text('å…ˆä»åŸå¸‚å°è±¡å¼€å§‹äº†è§£è¿™åº§åŸå¸‚').fontSize(16).fontColor('#666')
            this.HeroArchiveCard()
            Button('å±•å¼€å®Œæ•´å†…å®¹').onClick(() => this.currentStage = 'full')
          }
          .padding(16)
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F8F8F8') // è¿›å…¥æ•™å­¦æ€ï¼Œåˆ‡å›æ˜äº®èƒŒæ™¯
        }

        // ç¬¬å››é˜¶æ®µï¼šå®Œæ•´ ExploreView å†…å®¹
        else if (this.currentStage === 'full') {
          this.MainExploreContent()
        }
      }
      .width('100%')
      .height('100%')
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    }
    .width('100%')
    .height('100%')
  }

  @Builder MainExploreContent() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      Row() {
        Row() {
          SymbolGlyph($r('sys.symbol.location_north_up_right_and_circle_dotted_fill')).fontSize(18).fontColor(['#007DFF'])
          Text(this.currentCity).fontSize(14).fontWeight(FontWeight.Bold).margin({ left: 4 }).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
          SymbolGlyph($r('sys.symbol.chevron_down')).fontSize(12).fontColor(['#999'])
        }.onClick(() => this.showCityPicker()).width('28%')

        Search({ value: this.searchText, placeholder: 'æœç´¢ç›®çš„åœ°' })
          .layoutWeight(1).height(36).backgroundColor('#F1F3F5')
          .onChange((v) => this.searchText = v)

        Row() {
          SymbolGlyph(this.getWeatherIcon(this.weatherText)).fontSize(18).fontColor(['#FFAD0A'])
          Text(this.weatherInfo).fontSize(11).margin({ left: 3 })
        }.width('18%').justifyContent(FlexAlign.End)
      }.width('100%').padding(12).backgroundColor('#FFFFFF')

      Scroll() {
        Column({ space: 20 }) {
          // è½®æ’­å›¾ Banner
          Swiper() {
            if (CITY_BANNER_CONFIG[this.currentCity]) {
              ForEach(CITY_BANNER_CONFIG[this.currentCity], (item: CityBanner) => {
                this.BannerImageItem(item.title, item.image)
              }, (item: CityBanner) => `${this.currentCity}_${item.title}`)
            } else {
              this.BannerItem(`${this.currentCity} Â· å‘ç°æ›´å¤š`, '#DCDDE1')
            }
          }.width('100%').height(this.bannerHeight).autoPlay(true).borderRadius(12)

          // èŠ‚å¥æ–­ç‚¹ / å¼±æç¤ºæ–‡æ¡ˆ
          Text('åŸå¸‚ä¸æ­¢ä¸€ç§è¯»æ³•ã€‚').fontSize(12).fontColor('#999').margin({ top: 10, bottom: 8 })

          // å¯»åŸŸå¿«æŠ¥
          Row() {
            Text('å¯»åŸŸå¿«æŠ¥')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF4500')
              .flexShrink(0)

            Divider()
              .vertical(true)
              .height(24)
              .margin({ left: 8, right: 8 })
              .color('#EEE')
              .flexShrink(0)

            // å³ä¾§å†…å®¹åŒºåŸŸ
            if (this.isCitySwitching) {
              // â€”â€” å¿™ç¢Œæ€ â€”â€” //
              Text(`æ­£åœ¨åŒæ­¥ ${this.currentCity.replace('å¸‚', '')} åŸå¸‚å¿«æŠ¥â€¦`)
                .fontSize(12)
                .fontColor('#999')
                .opacity(0.8)
                .layoutWeight(1)
                .maxLines(1)
            } else {
              // â€”â€” æ­£å¸¸è½®æ’­æ€ â€”â€” //
              Swiper() {
                ForEach(this.newsList, (news: string) => {
                  Column() {
                    Text(news)
                      .fontSize(12)
                      .fontColor('#333')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .lineHeight(16)
                      .width('100%')
                  }
                  .justifyContent(FlexAlign.Center)
                  .height('100%')
                }, (item: string) => item)
              }
              .vertical(true)
              .autoPlay(true)
              .interval(4000)
              .indicator(false)
              .layoutWeight(1)
              .height(40)
            }
          }
          .width('100%')
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('#FFF5F5')
          .borderRadius(8)

          // åŠŸèƒ½é‡‘åˆšåŒº
          Column() {
            this.HeroArchiveCard()
            Row({ space: 12 }) {
              this.VerticalFeatureCard('åœ°åå¯»è¸ª', $r('sys.symbol.doc_text_fill'), '#A29BFE', 'æ¢ç´¢åœ°åèƒŒåçš„æ•…äº‹')
              Column({ space: 12 }) {
                this.HorizontalFeatureCard('å†å²è½´çº¿', $r('sys.symbol.timer_circle_fill'), '#65bb5c', 'ç©¿è¶Šæ—¶ç©ºçš„åŸå¸‚è„‰ç»œ')
                this.SquareFeatureCard('æ–‡åŒ–èµ„æº', $r('sys.symbol.flower'), '#FF2D55')
              }
              .width('54%')
            }
            .width('100%')
            .margin({ top: 16 })

            Text('æ¢ç´¢æœ¬åœ°ç”Ÿæ´»')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 25, bottom: 16, left: 4 })
              .alignSelf(ItemAlign.Start)

            Row() {
              this.GalleryCard('æ™¯ç‚¹æ¨è', $r('sys.symbol.camera_fill'), '#45B7D1')
              this.GalleryCard('åœºé¦†é¢„çº¦', $r('sys.symbol.house_fill'), '#F2994A')
              this.GalleryCard('ç‰¹äº§é£å‘³', $r('sys.symbol.fork_knife'), '#FF6B6B')
              this.GalleryCard('å…¨éƒ¨', $r('sys.symbol.square_fill_grid_2x2'), '#8E8E93')
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
            .backgroundColor(Color.White)
            .borderRadius(20)
            .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: 8 }) // æŸ”å’Œæµ®ç©ºæŠ•å½±
          }
          .padding({ left: 16, right: 16 })

          // èŠ‚å¥æ–­ç‚¹ / å¼±æç¤ºæ–‡æ¡ˆ
          Text('æ…¢æ…¢æ¢ç´¢ï¼Œæ¯ä¸€æ¬¡å‡ºè¡Œéƒ½æœ‰æƒŠå–œã€‚').fontSize(12).fontColor('#999').margin({ top: 10, bottom: 8 })

          // æ­£åœ¨è®¨è®º
          Column() {
            // æ‰¾åˆ°è¿™è¡Œ
            this.SectionHeader(`ä»Šå¤©çš„${this.currentCity.replace('å¸‚','')}åœ¨è®¨è®ºä»€ä¹ˆ`)
            Scroll() {
              Row({ space: 12 }) {
                ForEach(this.hotTopics, (topic: HotTopic) => {
                  this.TopicItem(topic.title, topic.count, topic.color)
                }, (item: HotTopic) => item.title)
              }
            }.scrollable(ScrollDirection.Horizontal).scrollBar(BarState.Off)
          }.opacity(this.isCitySwitching ? 0.5 : 1).enabled(!this.isCitySwitching) // ğŸ‘ˆ é˜²æ­¢åˆ‡æ¢ä¸­è¯¯è§¦

          // è·¯çº¿æ¨è
          Column() {
            this.SectionHeader(`ç¼–è¾‘æ¨è Â· è¡Œèµ°è·¯çº¿`)
            if (CITY_ROUTES[this.currentCity]?.length > 0) {
              ForEach(CITY_ROUTES[this.currentCity], (route: TravelRoute) => {
                this.NewRouteCard(route)
              }, (item: TravelRoute) => `${this.currentCity}_${item.routeName}`)
            } else {
              Column() {
                SymbolGlyph($r('sys.symbol.map_badge_cloud_slash_fill')).fontSize(30).fontColor(['#DDD'])
                Text(`${this.currentCity} è·¯çº¿æ­£åœ¨ç«é€Ÿè§„åˆ’ä¸­...`).fontSize(14).fontColor('#999').margin({ top: 10 })
              }.width('100%').padding(30)
            }
          }

          // é¡µé¢åº•éƒ¨å¼±ç»“æŸè¯­
          Column() {
            Text('æ¯åº§åŸå¸‚ï¼Œéƒ½å€¼å¾—è¢«æ…¢æ…¢è®¤è¯†ã€‚').fontSize(12).fontColor('#AAA').margin({ top: 15 })
          }.width('100%').height(80)

        }.padding(16)
      }.layoutWeight(1)
    }.width('100%').height('100%').backgroundColor('#F8F8F8')
  }

  @Builder BackgroundAtmosphere() {
    Stack() {
      Image($r('app.media.start'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover) // âœ… å…³é”®ï¼šç¡®ä¿æ¨ªå›¾åœ¨çºµå±ä¸‹è‡ªåŠ¨ä¸­å¿ƒè£å‰ª
        .blur(25)                 // âœ… ç¨å¾®åŠ å¤§æ¨¡ç³Šï¼Œåˆ©ç”¨äº‘å±‚çš„é‡‘è‰²å½¢æˆå…‰æ™•
        .opacity(0.5)              // ä¿æŒåŠé€æ˜
        .scale({ x: 1.2, y: 1.2 }) // âœ… ç¨å¾®åŠ å¤§åˆå§‹æ¯”ä¾‹ï¼Œç»™ Ken Burns æ•ˆæœç•™è¶³è£å‰ªç©ºé—´
        .animation({ duration: 12000, iterations: -1, curve: Curve.Linear }) // ææ…¢é€Ÿç§»åŠ¨

      // âœ… å»ºè®®åŠ ä¸€å±‚æå…¶å¾®å¼±çš„æš—è‰²è’™å±‚ï¼Œé˜²æ­¢å¤•é˜³å¤ªäº®ç›–ä½ç™½è‰²æ–‡å­—
      Rect()
        .width('100%')
        .height('100%')
        .fill(Color.Black)
        .opacity(0.15)
    }.width('100%').height('100%')

  }

  @Builder BannerImageItem(title: string, img: Resource) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Image(img).width('100%').height('100%').borderRadius(12).objectFit(ImageFit.Cover)
      Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#FFFFFF').margin(15)
        .textShadow({ radius: 8, color: '#90000000', offsetX: 2, offsetY: 2 })
    }
  }

  @Builder BannerItem(title: string, color: string) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Rect().width('100%').height('100%').fill(color).borderRadius(12).opacity(0.2)
      Text(title).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#333').margin(20)
    }
  }

  @Builder TopicItem(title: string, count: string, color: string) {
    Column() {
      Text(`# ${title}`).fontSize(14).fontWeight(FontWeight.Bold).fontColor('#333')
      Text(`${count} å‚ä¸è®¨è®º`).fontSize(11).fontColor('#666').margin({ top: 6 })
    }.width(140).height(70).padding(12).backgroundColor(color).borderRadius(12).alignItems(HorizontalAlign.Start).justifyContent(FlexAlign.Center)
  }

  @Builder SectionHeader(title: string) {
    Row() {
      Text(title).fontSize(18).fontWeight(FontWeight.Bold)
      Blank()
      Text('æ›´å¤š >').fontSize(12).fontColor('#999')
    }.width('100%').margin({ bottom: 15 })
  }

  @Builder NewRouteCard(route: TravelRoute) {
    Row() {
      Column() {
        Circle({ width: 6, height: 6 }).fill('#007DFF')
        Rect().width(1).height(15).fill('#D8D8D8')
        Circle({ width: 6, height: 6 }).fill(Color.Transparent).stroke('#007DFF').strokeWidth(1)
      }.margin({ right: 12 })
      Column() {
        Text(route.routeName).fontSize(15).fontWeight(FontWeight.Bold)
        Text(`${route.spots.length}ä¸ªæ‰“å¡ç‚¹ Â· å»ºè®®æ—¶é—´${route.spots.length > 3 ? '1å¤©' : 'åŠå¤©'}`).fontSize(12).fontColor('#666').margin({ top: 4 })
      }.layoutWeight(1).alignItems(HorizontalAlign.Start)
      Button('å¼€å§‹å¯¼è§ˆ').height(28).fontSize(11).backgroundColor('#007DFF').onClick(() => this.jumpToGuide(route))
    }.width('100%').padding(15).backgroundColor('#FFFFFF').borderRadius(12).margin({ bottom: 10 }).onClick(() => this.jumpToGuide(route))
  }

  // ğŸ–¼ï¸ ã€ç”»å·å…¥å£ã€‘åŸå¸‚å°è±¡
  @Builder HeroArchiveCard() {
    Stack({ alignContent: Alignment.BottomStart }) {
      // æ¨¡æ‹Ÿä¸€ä¸ªåŸå¸‚ç¼©ç•¥å›¾èƒŒæ™¯ï¼ˆå¯é…åˆä½ çš„åŸå¸‚æ•°æ®ï¼‰
      Image($r('app.media.city_impression_placeholder'))
        .width('100%').height(140).borderRadius(20).objectFit(ImageFit.Cover)
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#00000000', 0.0], ['#CC000000', 1.0]]
        })

      Column() {
        Text('åŸå¸‚å°è±¡').fontSize(22).fontWeight(FontWeight.Bolder).fontColor(Color.White)
        Text(`${this.currentCity} Â· åŸå¸‚æ¡£æ¡ˆæ€»è§ˆ`).fontSize(12).fontColor('rgba(255,255,255,0.8)').margin({ top: 4 })
      }.padding(20)
    }
    .width('100%')
    .onClick(() => {
      router.pushUrl({
        url: 'pages/features/DataDetailView',
        params: {
          title: 'åŸå¸‚å°è±¡',
          cityName: this.currentCity,
          color: '#333333',
          icon: $r('sys.symbol.bookmark_fill')
        }
      })
    })
  }

  // ğŸ“š ã€ç«–å‘æ¡£æ¡ˆã€‘åœ°åå¯»è¸ª
  @Builder VerticalFeatureCard(title: string, icon: Resource, color: string, desc: string) {
    Column() {
      SymbolGlyph(icon).fontSize(32).fontColor([color]).margin({ bottom: 15 })
      Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
      Text(desc).fontSize(10).fontColor('#999').margin({ top: 8 }).textAlign(TextAlign.Center)
      Blank()
      // è£…é¥°å…ƒç´ ï¼šåƒæ¡£æ¡ˆç´¢å¼•æ ‡ç­¾
      Rect().width(30).height(4).fill(color).borderRadius(2).opacity(0.3)
    }
    .height(180)
    .padding(20)
    .width('42%')
    .backgroundColor('#F8F9FF')
    .borderRadius({ topLeft: 30, bottomRight: 30, topRight: 10, bottomLeft: 10 }) // âœ… æå…·è¾¨è¯†åº¦çš„éå¯¹ç§°åœ†è§’
    .onClick(() => router.pushUrl({ url: 'pages/features/GeoOrigin' }))
  }

  // â³ ã€æ¨ªå‘è„‰ç»œã€‘å†å²è½´çº¿
  @Builder HorizontalFeatureCard(title: string, icon: Resource, color: string, desc: string) {
    Row() {
      Column() {
        Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
        Text(desc).fontSize(10).fontColor('#999').margin({ top: 4 })
      }.alignItems(HorizontalAlign.Start).layoutWeight(1)
      SymbolGlyph(icon).fontSize(26).fontColor([color])
    }
    .padding(18)
    .backgroundColor('#F5FFF9')
    .borderRadius(16)
    .onClick(() => router.pushUrl({ url: 'pages/features/CityHistoryPage' }))
  }

  // ğŸ¨ ã€ç”»å»Šå¡ç‰‡ã€‘æ™¯ç‚¹/ç‰¹äº§/æ–‡åŒ–
  @Builder GalleryCard(name: string, icon: Resource, color: string) {
    Column() {
      Stack() {
        // èƒŒæ™¯å¾®åœ†ç¯
        Circle({ width: 44, height: 44 })
          .fill(color)
          .opacity(0.08)
        SymbolGlyph(icon)
          .fontSize(22)
          .fontColor([color])
      }
      Text(name)
        .fontSize(12).fontWeight(FontWeight.Medium).fontColor('#444').margin({ top: 8 })
    }
    // ğŸ’¡ å…³é”®ï¼šä½¿ç”¨ 25% å®½åº¦å®ç°å››åˆ†å¹¶æ’
    .width('25%')
    .height(90)
    .justifyContent(FlexAlign.Center)
    // å¢åŠ ç‚¹å‡»åé¦ˆé€»è¾‘
    .onClick(() => {
      const pageMap: Record<string, string> = {
        'å…¨éƒ¨': 'pages/features/AllFunctionsView',
        'åœºé¦†é¢„çº¦': 'pages/features/VenueBookingView'
      };
      if (pageMap[name]) {
        router.pushUrl({ url: pageMap[name], params: { title: name, cityName: this.currentCity } });
      } else {
        promptAction.showToast({ message: `${name} åŠŸèƒ½å¼€å‘ä¸­...` });
      }
    })
  }

  @Builder SquareFeatureCard(title: string, icon: Resource, color: string) {
    Row() {
      SymbolGlyph(icon).fontSize(20).fontColor([color])
      Text(title).fontSize(14).fontWeight(FontWeight.Medium).fontColor('#333').margin({ left: 10 })
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#FFF9F5')
    .borderRadius(16)
    .onClick(() => {
      // const pageMap: Record<string, string> = {
      // };
      promptAction.showToast({ message: `å¯»åŸŸ Â· ${this.currentCity}æ–‡åŒ–èµ„æºåº“å»ºè®¾ä¸­...` })
    })
  }

  jumpToGuide(route: TravelRoute) {
    router.pushUrl({ url: 'pages/guide/GuideView', params: { route: route } })
  }
}
