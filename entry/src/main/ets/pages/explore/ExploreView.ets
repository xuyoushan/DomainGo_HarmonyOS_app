import { LocationManager } from '../../services/LocationManager';
import { common } from '@kit.AbilityKit';
import http from '@ohos.net.http';
import { PROVINCE_CITY_DATA } from '../../models/CityData';
import { CITY_BANNER_CONFIG, CityBanner } from '../../models/CityBannerData';
import { promptAction, router, display, window } from '@kit.ArkUI';
import { CITY_ROUTES, TravelRoute } from '../../models/RouteData';
import { CITY_EXPLORE_MAP, DEFAULT_EXPLORE_DATA, CityExploreConfig } from '../../models/ExploreCityData';
import { PreferenceManager } from '../../services/PreferenceManager';

interface WeatherNow { temperature: string; text: string; }
interface WeatherResult { now: WeatherNow; }
interface WeatherResponse { results: WeatherResult[]; }
interface HotTopic { title: string; color: string; count: string; }
interface TopicTemplate { suffix: string; color: string; }
interface MyNewsResponse { code: number; city: string; news: string[]; }

@Component
export struct ExploreView {
  @StorageLink('currentCity') currentCity: string = 'Ê≠¶Ê±âÂ∏Ç';
  @StorageLink('currentWeather') weatherInfo: string = '...';
  @State weatherText: string = 'Èò¥';
  @State searchText: string = '';
  @State scaleValue: number = 1.0;
  @State bannerHeight: number = 200;
  @State hotTopics: HotTopic[] = [];
  @State newsList: string[] = ["Ê≠£Âú®ËøûÊé•ÊñáÊóÖÂ§ßÊï∞ÊçÆ‰∏≠ÂøÉ..."];
  @State isCitySwitching: boolean = false
  @State currentStage: 'welcome' | 'stepGuide' | 'full' = 'welcome'
  @State guideStepIndex: number = 0
  @State displayedText: string = ''
  @State isTyping: boolean = false
  @State guideOpacity: number = 1.0;
  @StorageLink('hasCompletedGuide') hasCompletedGuide: boolean = false;
  @State isReady: boolean = true;
  @StorageLink('show_guide_manual') show_guide_manual: boolean = false;
  @State isDataLoaded: boolean = false;
  @State isShowGuideModal: boolean = false;
  @StorageLink('welcomeFinished') welcomeFinished: boolean = false;

  private timerId: number = -1

  private context = getContext(this) as common.UIAbilityContext;

  private getGuideSteps(): string[] {
    return [
      `Ê¨¢ËøéÊù•Âà∞ÂØªÂüü‰πãÊóÖ„ÄÇ\nÂú®ËøôÂ∫ßÂüéÂ∏ÇÔºåÊØèÊù°Ë°óÈÅì„ÄÅÊØèÂπ¢Âª∫Á≠ë„ÄÅÊØè‰∏™‰∫∫ÁöÑÁ¨ëÂ£∞ÈáåÔºåÈÉΩËóèÁùÄÁã¨ÁâπÁöÑÊïÖ‰∫ã„ÄÇ`,
      `ËøôÈáåÊúâË¢´Êó∂Èó¥ÈÅóÂøòÁöÑËÄÅÂ∑∑ÔºåÊúâË¢´ËÆ∞ÂøÜÈì≠ÂàªÁöÑÂéÜÂè≤Âª∫Á≠ë„ÄÇ\nËµ∞ËøõÂéªÔºå‰Ω†‰ºöÂèëÁé∞ÈÇ£‰∫õÂπ≥Âá°ËßíËêΩÈáåÈùûÂá°ÁöÑÁßòÂØÜ„ÄÇ`,
      `Âú®ËøôÈáåÔºå‰Ω†ÂèØ‰ª•ÊÖ¢ÊÖ¢ÂìÅÂë≥ÂüéÂ∏ÇÁöÑÂë≥ÈÅì„ÄÇ\nÊó†ËÆ∫ÊòØË°óÂ§¥Â∞èÂêÉÁöÑÈ¶ôÊ∞îÔºå\nËøòÊòØËÄÅËå∂È¶ÜÈáåÁöÑË∞àÁ¨ëÂ£∞Ôºå\nÈÉΩÂú®ËÆ≤Ëø∞Â±û‰∫éÂüéÂ∏ÇÁöÑÊ∏©Â∫¶„ÄÇ`,
      `ÊØè‰∏ÄÂ∫ßÂüéÂ∏ÇÈÉΩÊúâËá™Â∑±ÁöÑËäÇÂ•èÂíåËÑâÁªú„ÄÇ\nÂéÜÂè≤„ÄÅÊñáÂåñ„ÄÅÁîüÊ¥ªÂú®ËøôÈáå‰∫§ÁªáÔºåÊØè‰∏ÄÊ≠•Ë°åËµ∞ÔºåÈÉΩÊòØ‰∏ÄÊ¨°Êñ∞ÁöÑÂèëÁé∞„ÄÇ`,
      `ÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü\nËÆ©Êàë‰ª¨‰ªéËøôÈáåÂºÄÂßãÔºåÊÖ¢ÊÖ¢Ëß¶Êë∏ÂüéÂ∏ÇÁöÑÊïÖ‰∫ã„ÄÇ\n‰∏ÄÂú∫Êé¢Á¥¢‰πãÊóÖÂç≥Â∞ÜÂú®‰Ω†ÁöÑÊåáÂ∞ñÂ±ïÂºÄ„ÄÇ`,
      `ÁÇπÂáª‚ÄúÂºÄÂßãÊé¢Á¥¢‚Äù\nÂéªÂØªÂüü\nÂéª‰∫ÜËß£ÊØè‰∏™ÂäüËÉΩ„ÄÅÊØèÊù°Ë∑ØÁ∫ø„ÄÅÊØè‰∏™ÊïÖ‰∫ãÁöÑÁ≤æÂçé„ÄÇ`];
  }

  private playStepText() {
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }

    const steps = this.getGuideSteps()

    this.displayedText = '';
    this.isTyping = true;
    const fullText = steps[this.guideStepIndex];
    let i = 0;

    this.timerId = setInterval(() => {
      if (i < fullText.length) {
        this.displayedText += fullText[i];
        i++;
      } else {
        clearInterval(this.timerId);
        this.timerId = -1;
        this.isTyping = false;
      }
    }, 50);
  }

  private nextStep(total: number) {
    if (this.isTyping) return;
    if (this.guideStepIndex < total - 1) {
      this.guideStepIndex++;
      this.playStepText();
    }
  }

  private async enterMainPage() {
    await PreferenceManager.put(this.context, 'hasCompletedGuide', true);
    await PreferenceManager.put(this.context, 'show_guide_manual', false);
    AppStorage.setOrCreate('show_guide_manual', false);
    AppStorage.setOrCreate('welcomeFinished', true);

    const win = await window.getLastWindow(this.context);
    animateTo({
      duration: 888,
      curve: Curve.EaseInOut,
      onFinish: () => {
        this.currentStage = 'full';
      }
    }, () => {
      this.isReady = false;
      win.setWindowSystemBarEnable(['status', 'navigation']);
      win.setWindowLayoutFullScreen(false);
    })
  }

  getCityConfig(): CityExploreConfig {
    return CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
  }

  aboutToAppear() {
    if (this.welcomeFinished) {
      this.currentStage = 'full';
      this.isReady = false;
    } else {
      this.currentStage = 'welcome';
      this.isReady = true;
    }
    try {
      const displayData: display.Display = display.getDefaultDisplaySync();
      this.bannerHeight = px2vp(displayData.width) * 9 / 16;
    } catch (e) {
      this.bannerHeight = 200;
    }
    window.getLastWindow(this.context, (err: BusinessError, data: window.Window) => {
      const errCode: number = err.code;
      if (errCode) {
        console.error('Failed to get window: ' + JSON.stringify(err));
        return;
      }
      let win: window.Window = data;
      win.setWindowLayoutFullScreen(true);
      win.setWindowSystemBarEnable([]);
    });
  }

  onPageShow() {
    this.initLocation()
    this.fetchRealNews()
  }

  aboutToDisappear() {
    if (this.timerId !== -1) {
      clearInterval(this.timerId)
      this.timerId = -1
    }
  }

  async initLocation() {
    try {
      const isAuth = await LocationManager.requestPermission(this.context)
      if (isAuth) {
        const city = await LocationManager.getRealCity(this.context)
        if (city && city !== 'ÂÆö‰ΩçÂ§±Ë¥•') {
          this.updateCityState(city);
        }
      } else {
        this.fetchRealWeather(this.currentCity)
      }
    } catch (err) {
      this.fetchRealWeather(this.currentCity)
    }
  }

  private async updateCityState(city: string) {
    if (city === this.currentCity) return

    this.isCitySwitching = true
    this.currentCity = city
    AppStorage.setOrCreate('currentCity', city)

    await new Promise<void>((resolve) => {
      setTimeout(() => {
        resolve()
      }, 500)
    })

    await Promise.all([
      this.fetchRealWeather(city),
      this.fetchRealNews(),
      this.fetchHotTopics()
    ])

    this.isCitySwitching = false
    console.info(`[Explore] ÂüéÂ∏ÇÂàáÊç¢ÂÆåÊàê: ${city}`)
  }

  showCityPicker() {
    let provinces = Object.keys(PROVINCE_CITY_DATA);
    TextPickerDialog.show({
      range: provinces,
      onAccept: (pResult: TextPickerResult) => {
        let cities = PROVINCE_CITY_DATA[pResult.value as string];
        setTimeout(() => {
          TextPickerDialog.show({
            range: cities,
            onAccept: (cResult: TextPickerResult) => {
              this.updateCityState(cResult.value as string);
            }
          })
        }, 300)
      }
    })
  }

  async fetchRealWeather(city: string) {
    let httpRequest = http.createHttp();
    try {
      let queryCity = city.replace('Â∏Ç', '');
      let url = `https://api.seniverse.com/v3/weather/now.json?key=S7zKUHHMAcavQT0_R&location=${encodeURIComponent(queryCity)}&language=zh-Hans&unit=c`;
      let response = await httpRequest.request(url, { connectTimeout: 5000 });
      if (response.responseCode === 200) {
        let result = JSON.parse(response.result as string) as WeatherResponse;
        if (result.results?.length > 0) {
          let nowData = result.results[0].now;
          this.weatherInfo = `${nowData.temperature}¬∞C`;
          this.weatherText = nowData.text;
        }
      }
    } catch (err) {
      this.weatherInfo = 'ÁΩëÁªúÂºÇÂ∏∏';
    } finally {
      httpRequest.destroy();
    }
  }

  async fetchRealNews() {
    // --- üí° ÊñπÊ°àÂºÄÂÖ≥ ---
    const USE_REAL_CRAWLER = true;  // Ê®°ÂºèAÔºöÂêéÁ´ØÊäìÂèñÔºàÂÅöPPT/ÂΩïËßÜÈ¢ëÊó∂ÂºÄÂêØÔºâ
    // const USE_REAL_CRAWLER = false; // Ê®°ÂºèBÔºöÊú¨Âú∞Êï∞ÊçÆÔºàÁé∞Âú∫ÊºîÁ§∫/Êèê‰∫§‰ª£Á†ÅÊó∂ÂºÄÂêØÔºâ
    if (!USE_REAL_CRAWLER) {
      // „ÄêÊñπÊ°à‰∫åÔºöË∞ÉÁî®Êú¨Âú∞Êï∞ÊçÆ„Äë‚Äî‚Äî Ê®°Êãü‰∏Ä‰∏™Âä†ËΩΩËøáÁ®ãÔºåÊòæÂæóÊõ¥ÁúüÂÆû
      this.newsList = ["Ê≠£Âú®ËøûÊé•ÊñáÊóÖÊï∞ÊçÆ‰∏≠ÂøÉ...", "Ê≠£Âú®ÂêåÊ≠•ÂüéÂ∏ÇÂø´Êä•..."];
      setTimeout(() => {
        this.showLocalNews();
        console.info("Â∑≤Âä†ËΩΩÊú¨Âú∞Á≤æÂìÅÊñáÊóÖÊï∞ÊçÆ");
      }, 800); // ÊïÖÊÑèÂª∂Ëøü 0.8sÔºåÂÅöÂá∫‚ÄúËØ∑Ê±Ç‚ÄùÁöÑËßÜËßâÊïàÊûú
      return;
    }

    // „ÄêÊñπÊ°à‰∏ÄÔºöÂêéÁ´ØÊäìÂèñÊ®°Âºè„Äë‚Äî‚Äî ‰ªÖÂú®ÂºÄÂêØÊ®°ÂºèAÊó∂ÊâßË°å
    let isFinished = false;
    setTimeout(() => {
      if (!isFinished) {
        this.showLocalNews();
        isFinished = true;
      }
    }, 3000);

    let httpRequest = http.createHttp();
    const url = `http://192.168.103.83:5000/get_news/${encodeURIComponent(this.currentCity)}`;
    try {
      let response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: 4000,
        expectDataType: http.HttpDataType.OBJECT
      });

      const res = response.result as MyNewsResponse;
      const localData = CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;

      if (!isFinished && res.code === 200 && res.news.length > 0) {
        const realPart = res.news.slice(0, 3);
        const localPart = localData.news.slice(0, 3);
        this.newsList = realPart.concat(localPart).sort(() => Math.random() - 0.5);
        isFinished = true;
      }
    } catch (err) {
      if (!isFinished) {
        this.showLocalNews();
        isFinished = true;
      }
    } finally {
      httpRequest.destroy();
    }
  }

  showLocalNews() {
    const localData = CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
    this.newsList = [...localData.news].sort(() => Math.random() - 0.5);
  }

  async fetchHotTopics() {
    const config = CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
    const localKeywords = config.keywords;
    const city = this.currentCity.replace('Â∏Ç', '');

    const topicTemplates: TopicTemplate[] = [
      { suffix: 'Ê∑±Â∫¶Ê∏∏ÊîªÁï•', color: '#FFEAA7' },
      { suffix: 'Âú∞ÂêçËÉåÂêéÁöÑÊïÖ‰∫ã', color: '#81ECEC' },
      { suffix: 'ÂÆùËóèÊâìÂç°Âú∞ÂàÜ‰∫´', color: '#FAB1A0' },
      { suffix: 'ÁâπËâ≤ÁæéÈ£üÈÅøÈõ∑', color: '#D6E4FF' },
      { suffix: 'ÂéÜÂè≤Âª∫Á≠ëÊº´Ê≠•', color: '#E8F5E9' }
    ];

    this.hotTopics = localKeywords.slice(0, 5).map((key: string, index: number): HotTopic => {
      return {
        title: `${city}${key}${topicTemplates[index].suffix}`,
        color: topicTemplates[index].color,
        count: `${(Math.random() * 5 + 1).toFixed(1)}w`
      };
    });
  }

  getWeatherIcon(text: string): Resource {
    if (text.includes('Êô¥')) return $r('sys.symbol.sun_max_fill');
    if (text.includes('Èõ®')) return $r('sys.symbol.light_rain');
    if (text.includes('Èò¥') || text.includes('Â§ö‰∫ë')) return $r('sys.symbol.cloud_fill');
    return $r('sys.symbol.cloud_sun_fill');
  }

  build() {
    Stack() {
      if (!this.isReady || this.currentStage === 'full') {
        Column() {
          this.MainExploreContent()
        }
        .width('100%').height('100%')
      }

      if (this.isReady && this.currentStage !== 'full') {
        Stack() {
          this.BackgroundAtmosphere()
          Column() {
            if (this.currentStage === 'welcome') {
              this.WelcomeGuideUI()
            } else if (this.currentStage === 'stepGuide') {
              this.StepGuideUI()
            }
          }
          .width('100%').height('100%')
        }
        .width('100%')
        .height('100%')
        .backgroundColor(Color.Black)
        .zIndex(999)
        .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
        .transition(TransitionEffect.OPACITY.combine(TransitionEffect.scale({ x: 1.1, y: 1.1 })))
      }
    }
    .width('100%')
    .height('100%')
  }

  // ÂºïÂØºÈÄªËæë
  @Builder GuideContent() {
    Stack() {
      Rect().width('100%').height('100%').fill(Color.Black)
      if (this.currentStage === 'welcome' || this.currentStage === 'stepGuide') {
        this.BackgroundAtmosphere()
      }
      Column() {
        if (this.currentStage === 'welcome') {
          this.WelcomeGuideUI()
        } else if (this.currentStage === 'stepGuide') {
          this.StepGuideUI()
        }
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder WelcomeGuideUI() {
    Stack() {
      Image($r('app.media.start'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#20000000', 0.0], ['#80000000', 1.0]]
        })
      Column() {
        Text('ÂØª ¬∑ Âüü')
          .fontSize(48)
          .fontWeight(FontWeight.Lighter)
          .fontColor(Color.White)
          .letterSpacing(15)
          .margin({ bottom: 10 })

        Text('‚Äî‚Äî Ëß¶Êë∏ÊØè‰∏ÄÂ∫ßÂüéÂ∏ÇÁöÑÊ∏©Â∫¶ ‚Äî‚Äî')
          .fontSize(14)
          .fontColor('#CCFFFFFF')
          .letterSpacing(2)
          .margin({ bottom: 80 })

        Button() {
          Row({ space: 8 }) {
            Text('ÂºÄÂêØÊóÖÁ®ã').fontColor(Color.White).fontSize(16).fontWeight(FontWeight.Medium)
            SymbolGlyph($r('sys.symbol.arrow_right')).fontSize(18).fontColor([Color.White])
          }
        }
        .width(200)
        .height(56)
        .backgroundColor('rgba(255,255,255,0.15)')
        .backgroundBlurStyle(BlurStyle.Thin)
        .borderRadius(28)
        .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
        .onClick(async () => {
          const isFinished = await PreferenceManager.get(this.context, 'hasCompletedGuide', false) as boolean;
          const isManualOpen = await PreferenceManager.get(this.context, 'show_guide_manual', false) as boolean;
          console.info(`[ButtonCheck] Á£ÅÁõòÁä∂ÊÄÅ - Â∑≤ÂÆåÊàê: ${isFinished}, ÊâãÂä®ÂºÄÂÖ≥: ${isManualOpen}`);
          if (isFinished && !isManualOpen) {
            this.enterMainPage();
          } else {
            animateTo({ duration: 300 }, () => {
              this.currentStage = 'stepGuide';
            })
            this.guideStepIndex = 0;
            this.playStepText();
          }
        })
      }
      .width('100%')
      .padding({ bottom: 100 })
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.End)
    }
    .width('100%')
    .height('100%')
  }

  @Builder StepGuideUI() {
    Stack() {
      Column() {
        Text(this.displayedText).fontSize(20)
          .fontWeight(FontWeight.Lighter).fontColor(Color.White)
          .lineHeight(32).textAlign(TextAlign.Center)
          .margin({ left: 24, right: 24, bottom: 30 }).textShadow({ radius: 4, color: '#80000000', offsetY: 2 })
        if (!this.isTyping) {
          Button({ type: ButtonType.Capsule, stateEffect: true }) {
            Text(this.guideStepIndex < this.getGuideSteps().length - 1 ? '‰∏ã‰∏ÄÊ≠•' : 'ÂºÄÂßãÊé¢Á¥¢')
              .fontSize(16)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Medium)
              .letterSpacing(2)
          }
          .width(200).height(56)
          .linearGradient({
            direction: GradientDirection.Right,
            colors: [['#FF7F50', 0.0], ['#FF6B6B', 1.0]]
          })
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.5)' })
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White).fontSize(16)
          .backgroundBlurStyle(BlurStyle.Thin)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.5)' })
          .borderRadius(25)
          .shadow({
            radius: 15,
            color: 'rgba(255, 107, 107, 0.4)', // ÊåâÈíÆÂêåËâ≤Á≥ªÁöÑÂëºÂê∏ÊäïÂΩ±
            offsetY: 8
          })
          .scale({ x: this.scaleValue, y: this.scaleValue })
          .onTouch((event: TouchEvent) => {
            if (event.type === TouchType.Down) {
              animateTo({ duration: 100 }, () => { this.scaleValue = 0.95 })
            } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
              animateTo({ duration: 100 }, () => { this.scaleValue = 1.0 })
            }
          })
          .onClick(() => {
            if (this.guideStepIndex < this.getGuideSteps().length - 1) {
              this.nextStep(this.getGuideSteps().length);
            } else {
              this.enterMainPage();
            }
          })
        }
      }
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
      .width('100%')
      .height('100%')
      .onClick(() => this.nextStep(this.getGuideSteps().length))
    }
    .width('100%')
    .height('100%')
  }

  @Builder MainExploreContent() {
    Column() {
      // È°∂ÈÉ®Áä∂ÊÄÅÊ†è
      Row() {
        Row() {
          SymbolGlyph($r('sys.symbol.location_north_up_right_and_circle_dotted_fill')).fontSize(18).fontColor(['#007DFF'])
          Text(this.currentCity).fontSize(14).fontWeight(FontWeight.Bold).margin({ left: 4 }).maxLines(2).minFontSize(9).maxFontSize(14).textOverflow({ overflow: TextOverflow.Ellipsis }).constraintSize({ maxWidth: 80 }).textAlign(TextAlign.Start)
          SymbolGlyph($r('sys.symbol.chevron_down')).fontSize(12).fontColor(['#999'])
        }.onClick(() => this.showCityPicker()).width('28%')

        Search({ value: this.searchText, placeholder: 'ÊêúÁ¥¢ÁõÆÁöÑÂú∞' })
          .layoutWeight(1).height(36).backgroundColor('#F1F3F5')
          .onChange((v) => this.searchText = v)

        Row() {
          SymbolGlyph(this.getWeatherIcon(this.weatherText)).fontSize(18).fontColor(['#FFAD0A'])
          Text(this.weatherInfo).fontSize(11).margin({ left: 3 })
        }.width('18%').justifyContent(FlexAlign.End)
      }.width('100%').padding(12).backgroundColor('#FFFFFF')

      Scroll() {
        Column({ space: 20 }) {
          // ËΩÆÊí≠Âõæ Banner
          Swiper() {
            if (CITY_BANNER_CONFIG[this.currentCity]) {
              ForEach(CITY_BANNER_CONFIG[this.currentCity], (item: CityBanner) => {
                this.BannerImageItem(item.title, item.image)
              }, (item: CityBanner) => `${this.currentCity}_${item.title}`)
            } else {
              this.BannerItem(`${this.currentCity} ¬∑ ÂèëÁé∞Êõ¥Â§ö`, '#DCDDE1')
            }
          }.width('100%').height(this.bannerHeight).autoPlay(true).borderRadius(12)

          // ËäÇÂ•èÊñ≠ÁÇπ / Âº±ÊèêÁ§∫ÊñáÊ°à
          Text('ÂüéÂ∏Ç‰∏çÊ≠¢‰∏ÄÁßçËØªÊ≥ï„ÄÇ').fontSize(12).fontColor('#999').margin({ top: 10, bottom: 8 })

          // ÂØªÂüüÂø´Êä•
          Row() {
            Text('ÂØªÂüüÂø´Êä•')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF4500')
              .flexShrink(0)

            Divider()
              .vertical(true)
              .height(24)
              .margin({ left: 8, right: 8 })
              .color('#EEE')
              .flexShrink(0)

            // Âè≥‰æßÂÜÖÂÆπÂå∫Âüü
            if (this.isCitySwitching) {
              // ‚Äî‚Äî ÂøôÁ¢åÊÄÅ ‚Äî‚Äî //
              Text(`Ê≠£Âú®ÂêåÊ≠• ${this.currentCity.replace('Â∏Ç', '')} ÂüéÂ∏ÇÂø´Êä•‚Ä¶`)
                .fontSize(12)
                .fontColor('#999')
                .opacity(0.8)
                .layoutWeight(1)
                .maxLines(1)
            } else {
              // ‚Äî‚Äî Ê≠£Â∏∏ËΩÆÊí≠ÊÄÅ ‚Äî‚Äî //
              Swiper() {
                ForEach(this.newsList, (news: string) => {
                  Column() {
                    Text(news)
                      .fontSize(12)
                      .fontColor('#333')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .lineHeight(16)
                      .width('100%')
                  }
                  .justifyContent(FlexAlign.Center)
                  .height('100%')
                }, (item: string) => item)
              }
              .vertical(true)
              .autoPlay(true)
              .interval(4000)
              .indicator(false)
              .layoutWeight(1)
              .height(40)
            }
          }
          .width('100%')
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('#FFF5F5')
          .borderRadius(8)

          // ÂäüËÉΩÈáëÂàöÂå∫
          Column() {
            this.HeroArchiveCard()
            Row({ space: 12 }) {
              this.VerticalFeatureCard('Âú∞ÂêçÂØªË∏™', $r('sys.symbol.doc_text_fill'), '#A29BFE', 'Êé¢Á¥¢Âú∞ÂêçËÉåÂêéÁöÑÊïÖ‰∫ã')
              Column({ space: 12 }) {
                this.HorizontalFeatureCard('ÂéÜÂè≤ËΩ¥Á∫ø', $r('sys.symbol.timer_circle_fill'), '#65bb5c', 'Á©øË∂äÊó∂Á©∫ÁöÑÂüéÂ∏ÇËÑâÁªú')
                this.SquareFeatureCard('ÊñáÂåñËµÑÊ∫ê', $r('sys.symbol.flower'), '#FF2D55')
              }
              .width('54%')
            }
            .width('100%')
            .margin({ top: 16 })

            Text('Êé¢Á¥¢Êú¨Âú∞ÁîüÊ¥ª')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 25, bottom: 16, left: 4 })
              .alignSelf(ItemAlign.Start)

            Row() {
              this.GalleryCard('ÊôØÁÇπÊé®Ëçê', $r('sys.symbol.camera_fill'), '#45B7D1')
              this.GalleryCard('Âú∫È¶ÜÈ¢ÑÁ∫¶', $r('sys.symbol.house_fill'), '#F2994A')
              this.GalleryCard('Áâπ‰∫ßÈ£éÂë≥', $r('sys.symbol.fork_knife'), '#FF6B6B')
              this.GalleryCard('ÂÖ®ÈÉ®', $r('sys.symbol.square_fill_grid_2x2'), '#8E8E93')
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
            .backgroundColor(Color.White)
            .borderRadius(20)
            .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: 8 }) // ÊüîÂíåÊµÆÁ©∫ÊäïÂΩ±
          }
          .padding({ left: 16, right: 16 })
          // ËäÇÂ•èÊñ≠ÁÇπ / Âº±ÊèêÁ§∫ÊñáÊ°à
          Text('ÊÖ¢ÊÖ¢Êé¢Á¥¢ÔºåÊØè‰∏ÄÊ¨°Âá∫Ë°åÈÉΩÊúâÊÉäÂñú„ÄÇ').fontSize(12).fontColor('#999').margin({ top: 10, bottom: 8 })

          // Ê≠£Âú®ËÆ®ËÆ∫
          Column() {
            this.SectionHeader(`‰ªäÂ§©ÁöÑ${this.currentCity.replace('Â∏Ç','')}Âú®ËÆ®ËÆ∫‰ªÄ‰πà`)
            Scroll() {
              Row({ space: 12 }) {
                ForEach(this.hotTopics, (topic: HotTopic) => {
                  this.TopicItem(topic.title, topic.count, topic.color)
                }, (item: HotTopic) => item.title)
              }
            }.scrollable(ScrollDirection.Horizontal).scrollBar(BarState.Off)
          }.opacity(this.isCitySwitching ? 0.5 : 1).enabled(!this.isCitySwitching)
          Column() {
            this.SectionHeader(`ÁºñËæëÊé®Ëçê ¬∑ Ë°åËµ∞Ë∑ØÁ∫ø`)
            if (CITY_ROUTES[this.currentCity]?.length > 0) {
              ForEach(CITY_ROUTES[this.currentCity], (route: TravelRoute) => {
                this.NewRouteCard(route)
              }, (item: TravelRoute) => `${this.currentCity}_${item.routeName}`)
            } else {
              Column() {
                SymbolGlyph($r('sys.symbol.map_badge_cloud_slash_fill')).fontSize(30).fontColor(['#DDD'])
                Text(`${this.currentCity} Ë∑ØÁ∫øÊ≠£Âú®ÁÅ´ÈÄüËßÑÂàí‰∏≠...`).fontSize(14).fontColor('#999').margin({ top: 10 })
              }.width('100%').padding(30)
            }
          }

          // È°µÈù¢Â∫ïÈÉ®Âº±ÁªìÊùüËØ≠
          Column() {
            Text('ÊØèÂ∫ßÂüéÂ∏ÇÔºåÈÉΩÂÄºÂæóË¢´ÊÖ¢ÊÖ¢ËÆ§ËØÜ„ÄÇ').fontSize(12).fontColor('#AAA').margin({ top: 15 })
          }.width('100%').height(80)

        }.padding(16)
      }.layoutWeight(1)
    }.width('100%').height('100%').backgroundColor('#F8F8F8')
  }

  @Builder BackgroundAtmosphere() {
    Stack() {
      Image($r('app.media.start'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover) // ‚úÖ ÂÖ≥ÈîÆÔºöÁ°Æ‰øùÊ®™ÂõæÂú®Á∫µÂ±è‰∏ãËá™Âä®‰∏≠ÂøÉË£ÅÂâ™
        .blur(25)                 // ‚úÖ Á®çÂæÆÂä†Â§ßÊ®°Á≥äÔºåÂà©Áî®‰∫ëÂ±ÇÁöÑÈáëËâ≤ÂΩ¢ÊàêÂÖâÊôï
        .opacity(0.6)              // ‰øùÊåÅÂçäÈÄèÊòé
        .scale({ x: 1.2, y: 1.2 }) // ‚úÖ Á®çÂæÆÂä†Â§ßÂàùÂßãÊØî‰æãÔºåÁªô Ken Burns ÊïàÊûúÁïôË∂≥Ë£ÅÂâ™Á©∫Èó¥
        .animation({ duration: 12000, iterations: -1, curve: Curve.Linear })
      Rect()
        .width('100%')
        .height('100%')
        .fill(Color.Black)
        .opacity(0.15)
    }.width('100%').height('100%')
    .hitTestBehavior(HitTestMode.None)
  }

  @Builder BannerImageItem(title: string, img: Resource) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Image(img).width('100%').height('100%').borderRadius(12).objectFit(ImageFit.Cover)
      Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#FFFFFF').margin(15)
        .textShadow({ radius: 8, color: '#90000000', offsetX: 2, offsetY: 2 })
    }
  }

  @Builder BannerItem(title: string, color: string) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Rect().width('100%').height('100%').fill(color).borderRadius(12).opacity(0.2)
      Text(title).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#333').margin(20)
    }
  }

  @Builder TopicItem(title: string, count: string, color: string) {
    Column() {
      Text(`# ${title}`).fontSize(14).fontWeight(FontWeight.Bold).fontColor('#333')
      Text(`${count} ÂèÇ‰∏éËÆ®ËÆ∫`).fontSize(11).fontColor('#666').margin({ top: 6 })
    }.width(140).height(70).padding(12).backgroundColor(color).borderRadius(12).alignItems(HorizontalAlign.Start).justifyContent(FlexAlign.Center)
  }

  @Builder SectionHeader(title: string) {
    Row() {
      Text(title).fontSize(18).fontWeight(FontWeight.Bold)
      Blank()
      Text('Êõ¥Â§ö >').fontSize(12).fontColor('#999')
    }.width('100%').margin({ bottom: 15 })
  }

  @Builder NewRouteCard(route: TravelRoute) {
    Row() {
      Column() {
        Circle({ width: 6, height: 6 }).fill('#007DFF')
        Rect().width(1).height(15).fill('#D8D8D8')
        Circle({ width: 6, height: 6 }).fill(Color.Transparent).stroke('#007DFF').strokeWidth(1)
      }.margin({ right: 12 })
      Column() {
        Text(route.routeName).fontSize(15).fontWeight(FontWeight.Bold)
        Text(`${route.spots.length}‰∏™ÊâìÂç°ÁÇπ ¬∑ Âª∫ËÆÆÊó∂Èó¥${route.spots.length > 3 ? '1Â§©' : 'ÂçäÂ§©'}`).fontSize(12).fontColor('#666').margin({ top: 4 })
      }.layoutWeight(1).alignItems(HorizontalAlign.Start)
      Button('ÂºÄÂßãÂØºËßà').height(28).fontSize(11).backgroundColor('#007DFF').onClick(() => this.jumpToGuide(route))
    }.width('100%').padding(15).backgroundColor('#FFFFFF').borderRadius(12).margin({ bottom: 10 }).onClick(() => this.jumpToGuide(route))
  }

  // üñºÔ∏è „ÄêÁîªÂç∑ÂÖ•Âè£„ÄëÂüéÂ∏ÇÂç∞Ë±°
  @Builder HeroArchiveCard() {
    Stack({ alignContent: Alignment.BottomStart }) {
      // Ê®°Êãü‰∏Ä‰∏™ÂüéÂ∏ÇÁº©Áï•ÂõæËÉåÊôØÔºàÂèØÈÖçÂêà‰Ω†ÁöÑÂüéÂ∏ÇÊï∞ÊçÆÔºâ
      Image($r('app.media.city_impression_placeholder'))
        .width('100%').height(140).borderRadius(20).objectFit(ImageFit.Cover)
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#00000000', 0.0], ['#CC000000', 1.0]]
        })

      Column() {
        Text('ÂüéÂ∏ÇÂç∞Ë±°').fontSize(22).fontWeight(FontWeight.Bolder).fontColor(Color.White)
        Text(`${this.currentCity} ¬∑ ÂüéÂ∏ÇÊ°£Ê°àÊÄªËßà`).fontSize(12).fontColor('rgba(255,255,255,0.8)').margin({ top: 4 })
      }.padding(20)
    }
    .width('100%')
    .onClick(() => {
      router.pushUrl({
        url: 'pages/features/explore/DataDetailView',
        params: {
          title: 'ÂüéÂ∏ÇÂç∞Ë±°',
          cityName: this.currentCity,
          color: '#333333',
          icon: $r('sys.symbol.bookmark_fill')
        }
      })
    })
  }

  // üìö „ÄêÁ´ñÂêëÊ°£Ê°à„ÄëÂú∞ÂêçÂØªË∏™
  @Builder VerticalFeatureCard(title: string, icon: Resource, color: string, desc: string) {
    Column() {
      SymbolGlyph(icon).fontSize(32).fontColor([color]).margin({ bottom: 15 })
      Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
      Text(desc).fontSize(10).fontColor('#999').margin({ top: 8 }).textAlign(TextAlign.Center)
      Blank()
      Rect().width(30).height(4).fill(color).borderRadius(2).opacity(0.3)
    }
    .height(180)
    .padding(20)
    .width('42%')
    .backgroundColor('#F8F9FF')
    .borderRadius({ topLeft: 30, bottomRight: 30, topRight: 10, bottomLeft: 10 })
    .onClick(() => router.pushUrl({ url: 'pages/features/explore/GeoOrigin' }))
  }

  // ‚è≥ „ÄêÊ®™ÂêëËÑâÁªú„ÄëÂéÜÂè≤ËΩ¥Á∫ø
  @Builder HorizontalFeatureCard(title: string, icon: Resource, color: string, desc: string) {
    Row() {
      Column() {
        Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
        Text(desc).fontSize(10).fontColor('#999').margin({ top: 4 })
      }.alignItems(HorizontalAlign.Start).layoutWeight(1)
      SymbolGlyph(icon).fontSize(26).fontColor([color])
    }
    .padding(18)
    .backgroundColor('#F5FFF9')
    .borderRadius(16)
    .onClick(() => router.pushUrl({ url: 'pages/features/explore/CityHistoryPage' }))
  }

  // üé® „ÄêÁîªÂªäÂç°Áâá„ÄëÊôØÁÇπ/Áâπ‰∫ß/ÊñáÂåñ
  @Builder GalleryCard(name: string, icon: Resource, color: string) {
    Column() {
      Stack() {
        Circle({ width: 44, height: 44 })
          .fill(color)
          .opacity(0.08)
        SymbolGlyph(icon)
          .fontSize(22)
          .fontColor([color])
      }
      Text(name)
        .fontSize(12).fontWeight(FontWeight.Medium).fontColor('#444').margin({ top: 8 })
    }
    .width('25%')
    .height(90)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      const pageMap: Record<string, string> = {
        'ÂÖ®ÈÉ®': 'pages/features/explore/AllFunctionsView',
        'Âú∫È¶ÜÈ¢ÑÁ∫¶': 'pages/features/explore/VenueBookingView',
        'Áâπ‰∫ßÈ£éÂë≥': 'pages/features/explore/SpecialtyView'
      };
      if (pageMap[name]) {router.pushUrl({ url: pageMap[name], params: { cityName: this.currentCity } });
      } else if (name === 'ÊñáÂåñËµÑÊ∫ê') {
        router.pushUrl({ url: 'pages/features/explore/CultureView', params: { cityName: this.currentCity } });
      } else {
        promptAction.showToast({ message: `${name} ÂäüËÉΩÂºÄÂèë‰∏≠...` });
      }
    })
  }

  @Builder SquareFeatureCard(title: string, icon: Resource, color: string) {
    Row() {
      SymbolGlyph(icon).fontSize(20).fontColor([color])
      Text(title).fontSize(14).fontWeight(FontWeight.Medium).fontColor('#333').margin({ left: 10 })
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#FFF9F5')
    .borderRadius(16)
    .onClick(() => {router.pushUrl({ url: 'pages/features/explores/CultureView', params: { cityName: this.currentCity } });
    })
  }

  jumpToGuide(route: TravelRoute) {
    router.pushUrl({ url: 'pages/guide/GuideView', params: { route: route } })
  }
}