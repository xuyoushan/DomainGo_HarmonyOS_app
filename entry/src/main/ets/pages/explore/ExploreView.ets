import { LocationManager, RealLocation } from '../../services/LocationManager';
import { common } from '@kit.AbilityKit';
import http from '@ohos.net.http';
import { PROVINCE_CITY_DATA } from '../../models/CityData';
import { CITY_BANNER_CONFIG, CityBanner } from '../../models/CityBannerData';
import { promptAction, router } from '@kit.ArkUI';
import { CITY_ROUTES, TravelRoute, ScenicSpot } from '../../models/RouteData';

// --- å…³é”®ï¼šå¼•å…¥å¤–éƒ¨åŠ¨æ€åŸŽå¸‚æ•°æ® ---
import { CITY_EXPLORE_MAP, DEFAULT_EXPLORE_DATA, CityExploreConfig } from '../../models/ExploreCityData';

interface WeatherNow { temperature: string; text: string; }
interface WeatherResult { now: WeatherNow; }
interface WeatherResponse { results: WeatherResult[]; }

// å®šä¹‰è¯é¢˜æŽ¥å£
interface HotTopic { title: string; color: string; count: string; }

@Component
export struct ExploreView {
  @StorageLink('currentCity') currentCity: string = 'æ­¦æ±‰å¸‚';
  @StorageLink('currentWeather') weatherInfo: string = '...';
  @State weatherText: string = 'é˜´';
  @State searchText: string = '';

  @State hotTopics: HotTopic[] = [
    { title: 'æ­¦æ±‰æ¨±èŠ±åœ°å›¾', color: '#FFEAA7', count: '3.5w' },
    { title: 'è€æ±‰å£å»ºç­‘å¯»è¸ª', color: '#81ECEC', count: '1.2w' },
    { title: 'åœ°åç½‘å¯»æ ¹ä¹‹æ—…', color: '#FAB1A0', count: '8900' }
  ];

  private context = getContext(this) as common.UIAbilityContext;

  // âœ… è¾…åŠ©æ–¹æ³•ï¼šèŽ·å–å½“å‰åŸŽå¸‚çš„å®žæ—¶é…ç½®
  getCityConfig(): CityExploreConfig {
    return CITY_EXPLORE_MAP[this.currentCity] || DEFAULT_EXPLORE_DATA;
  }

  aboutToAppear() {
    // ðŸ”¥ è¿›å…¥é¡µé¢å°±èŽ·å–å®šä½ï¼ˆåŽå°å®Œæˆï¼‰
    this.initLocation();
  }

  async initLocation() {
    try {
      const isAuth = await LocationManager.requestPermission(this.context)
      if (isAuth) {
        // èŽ·å–çœŸå®žåŸŽå¸‚
        const city = await LocationManager.getRealCity(this.context)
        if (city) {
          this.currentCity = city
          AppStorage.setOrCreate('currentCity', city)
          console.info('[Explore] å®šä½åŸŽå¸‚:', city)
          // åˆ·æ–°å¤©æ°”
          this.fetchRealWeather(city)
        }
      } else {
        console.warn('[Explore] å®šä½æƒé™æœªæŽˆäºˆï¼Œä½¿ç”¨é»˜è®¤åŸŽå¸‚', this.currentCity)
        this.fetchRealWeather(this.currentCity)
      }
    } catch (err) {
      console.error('[Explore] å®šä½å¤±è´¥', err)
      this.fetchRealWeather(this.currentCity)
    }
  }



  // åŸŽå¸‚é€‰æ‹©å™¨ï¼šä¿ç•™åŽŸé€»è¾‘
  showCityPicker() {
    let provinces = Object.keys(PROVINCE_CITY_DATA);
    TextPickerDialog.show({
      range: provinces,
      selected: 0,
      onAccept: (pResult: TextPickerResult) => {
        let selectedProvince = pResult.value as string;
        let cities = PROVINCE_CITY_DATA[selectedProvince];
        setTimeout(() => {
          TextPickerDialog.show({
            range: cities,
            selected: 0,
            onAccept: (cResult: TextPickerResult) => {
              let selectedCity = cResult.value as string;
              this.currentCity = selectedCity;
              this.fetchRealWeather(selectedCity);
            }
          })
        }, 300)
      }
    })
  }

  // å¤©æ°”èŽ·å–ï¼šä¿ç•™åŽŸé€»è¾‘
  async fetchRealWeather(city: string) {
    let httpRequest = http.createHttp();
    let apiKey = 'S7zKUHHMAcavQT0_R';
    this.weatherInfo = '...';
    try {
      let queryCity = city.replace('å¸‚', '');
      let url = `https://api.seniverse.com/v3/weather/now.json?key=${apiKey}&location=${encodeURIComponent(queryCity)}&language=zh-Hans&unit=c&ts=${Date.now()}`;
      let response = await httpRequest.request(url);
      if (response.responseCode === 200) {
        let result = JSON.parse(response.result as string) as WeatherResponse;
        if (result.results && result.results.length > 0) {
          let nowData = result.results[0].now;
          this.weatherInfo = `${nowData.temperature}Â°C`;
          this.weatherText = nowData.text;
        }
      }
    } catch (err) {
      this.weatherInfo = 'ç½‘ç»œå¼‚å¸¸';
    } finally {
      httpRequest.destroy();
    }
  }

  // // å®šä½åˆå§‹åŒ–ï¼šä¿ç•™åŽŸé€»è¾‘
  // async initLocation() {
  //   let isAuth = await LocationManager.requestPermission(this.context);
  //   if (isAuth) {
  //     const res = await LocationManager.getRealCity();
  //     if (res) {
  //       AppStorage.setOrCreate('currentCity', res);
  //       this.currentCity = res;
  //       this.fetchRealWeather(res);
  //     }
  //   } else {
  //     this.fetchRealWeather(this.currentCity);
  //   }
  // }

  getWeatherIcon(text: string): Resource {
    if (text.includes('æ™´')) return $r('sys.symbol.sun_max_fill');
    if (text.includes('é›¨')) return $r('sys.symbol.light_rain');
    if (text.includes('é˜´') || text.includes('å¤šäº‘')) return $r('sys.symbol.cloud_fill');
    return $r('sys.symbol.cloud_sun_fill');
  }

  build() {
    Column() {
      // --- é¡¶éƒ¨çŠ¶æ€æ  ---
      Row() {
        Row() {
          SymbolGlyph($r('sys.symbol.location_north_up_right_and_circle_dotted_fill')).fontSize(18).fontColor(['#007DFF'])
          Text(this.currentCity).fontSize(14).fontWeight(FontWeight.Bold).margin({ left: 4 }).maxLines(1)
          SymbolGlyph($r('sys.symbol.chevron_down')).fontSize(12).fontColor(['#999'])
        }.onClick(() => this.showCityPicker()).width('32%')

        Search({ value: this.searchText, placeholder: 'æœç´¢ç›®çš„åœ°' })
          .layoutWeight(1).height(36).backgroundColor('#F1F3F5')

        Row() {
          SymbolGlyph(this.getWeatherIcon(this.weatherText)).fontSize(18).fontColor(['#FFAD0A'])
          Text(this.weatherInfo).fontSize(11).margin({ left: 3 })
        }.width('18%').justifyContent(FlexAlign.End)
      }.width('100%').padding(12).backgroundColor('#FFFFFF')

      Scroll() {
        Column({ space: 20 }) {
          // --- è½®æ’­å›¾ (å·²ä¿®æ”¹ï¼šç§»é™¤ bannerListï¼Œç›´æŽ¥è¯»å–é…ç½®) ---
          Swiper() {
            if (CITY_BANNER_CONFIG[this.currentCity]) {
              ForEach(CITY_BANNER_CONFIG[this.currentCity], (item: CityBanner) => {
                this.BannerImageItem(item.title, item.image)
              }, (item: CityBanner) => item.title)
            } else {
              // å…œåº•è‰²å—ï¼Œä¿ç•™åŠŸèƒ½
              this.BannerItem(`${this.currentCity} Â· å‘çŽ°æ›´å¤š`, '#DCDDE1')
            }
          }
          .width('100%').height(180).autoPlay(true).borderRadius(12)

          // --- å¯»åŸŸå¿«æŠ¥ (å·²ä¿®æ”¹ï¼šæŽ¥å…¥ getCityConfig().news) ---
          Row() {
            Text('å¯»åŸŸå¿«æŠ¥').fontSize(14).fontWeight(FontWeight.Bold).fontColor('#FF4500')
            Divider().vertical(true).height(14).margin({ left: 8, right: 8 }).color('#EEE')
            Swiper() {
              ForEach(this.getCityConfig().news, (news: string) => {
                Text(news).fontSize(12).fontColor('#333').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
              }, (item: string) => item)
            }.vertical(true).autoPlay(true).indicator(false).layoutWeight(1).height(20)
          }
          .width('100%').padding(12).backgroundColor('#FFF5F5').borderRadius(8)

          // --- çƒ­é—¨æœç´¢è¯ (å·²ä¿®æ”¹ï¼šæŽ¥å…¥ getCityConfig().keywords) ---
          Scroll() {
            Row() {
              ForEach(this.getCityConfig().keywords, (word: string) => {
                Text(word).fontSize(12).fontColor('#666').backgroundColor('#FFFFFF').padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .borderRadius(15).margin({ right: 8 }).border({ width: 1, color: '#F1F3F5' })
                  .onClick(() => this.searchText = word)
              }, (item: string) => item)
            }
          }.scrollable(ScrollDirection.Horizontal).scrollBar(BarState.Off)

          // --- ä¸‰æŽ’åŠŸèƒ½åŒº (ä¿ç•™åŽŸé€»è¾‘) ---
          Column() {
            Row() {
              this.CategoryIcon('åŸŽå¸‚å°è±¡', $r('sys.symbol.bookmark_fill'), '#007DFF')
              this.CategoryIcon('è¡Œæ”¿åŒºåˆ’', $r('sys.symbol.map'), '#4ECDC4')
              this.CategoryIcon('åœ°åæ•…äº‹', $r('sys.symbol.doc_text_fill'), '#A29BFE')
              this.CategoryIcon('åŸŽå¸‚åäºº', $r('sys.symbol.person_crop_circle_fill'), '#FF9500')
            }.width('100%')

            Row() {
              this.CategoryIcon('åŽ†å²è½´çº¿', $r('sys.symbol.timer_circle_fill'), '#65bb5c')
              this.CategoryIcon('æ–‡åŒ–èµ„æº', $r('sys.symbol.flower'), '#FF2D55')
              this.CategoryIcon('ç‰¹äº§é£Žå‘³', $r('sys.symbol.fork_knife'), '#FF6B6B')
              this.CategoryIcon('æ™¯ç‚¹æŽ¨è', $r('sys.symbol.camera_fill'), '#45B7D1')
            }.width('100%').margin({ top: 15 })

            Row() {
              this.CategoryIcon('äº¤é€šå‡ºè¡Œ', $r('sys.symbol.car_fill'), '#5AC8FA')
              this.CategoryIcon('éšæ‰‹ç¬”è®°', $r('sys.symbol.square_and_pencil'), '#FAB1A0')
              this.CategoryIcon('è¡Œç¨‹å®‰æŽ’', $r('sys.symbol.calendar_001_fill'), '#9B51E0')
              this.CategoryIcon('å…¨éƒ¨', $r('sys.symbol.square_fill_grid_2x2'), '#8E8E93', true)
            }.width('100%').margin({ top: 15 })
          }.width('100%')

          // --- æ­£åœ¨è®¨è®º (ä¿ç•™åŽŸé€»è¾‘) ---
          Column() {
            this.SectionHeader('æ­£åœ¨è®¨è®º')
            Scroll() {
              Row({ space: 12 }) {
                ForEach(this.hotTopics, (topic: HotTopic) => {
                  this.TopicItem(topic.title, topic.count, topic.color)
                }, (item: HotTopic) => item.title)
              }
            }.scrollable(ScrollDirection.Horizontal).scrollBar(BarState.Off)
          }

          // --- åŠ¨æ€è·¯çº¿æŽ¨è (ä¿ç•™åŽŸé€»è¾‘) ---
          Column() {
            this.SectionHeader(`å¯»åŸŸ Â· ${this.currentCity}ç²¾å“è·¯çº¿`)
            if (CITY_ROUTES[this.currentCity] && CITY_ROUTES[this.currentCity].length > 0) {
              ForEach(CITY_ROUTES[this.currentCity], (route: TravelRoute) => {
                this.NewRouteCard(route)
              }, (item: TravelRoute) => item.routeName)
            } else {
              Column() {
                SymbolGlyph($r('sys.symbol.map_badge_cloud_slash_fill')).fontSize(30).fontColor(['#DDD'])
                Text(`${this.currentCity} è·¯çº¿æ­£åœ¨ç«é€Ÿè§„åˆ’ä¸­...`)
                  .fontSize(14).fontColor('#999').margin({ top: 10 })
              }.width('100%').padding(30).alignItems(HorizontalAlign.Center)
            }
          }
          Column().height(80)
        }.padding(16)
      }.layoutWeight(1)
    }.width('100%').height('100%').backgroundColor('#F8F8F8')
  }

  // --- æ‰€æœ‰åŽŸæœ‰ Builder å®Œæ•´ä¿ç•™ ---
  @Builder BannerImageItem(title: string, img: Resource) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Image(img).width('100%').height('100%').borderRadius(12).objectFit(ImageFit.Cover)
      Text(title)
        .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
        .margin(15).textShadow({ radius: 8, color: '#90000000', offsetX: 2, offsetY: 2 })
    }
  }

  @Builder BannerItem(title: string, color: string) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Rect().width('100%').height('100%').fill(color).borderRadius(12).opacity(0.2)
      Text(title).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#333').margin(20)
    }
  }

  @Builder CategoryIcon(name: string, icon: Resource, color: string, isAll: boolean = false) {
    Column() {
      Stack() {
        Circle().width(45).height(45).fill(color).opacity(0.1)
        SymbolGlyph(icon).fontColor([color]).fontSize(22)
      }
      Text(name).fontSize(12).margin({ top: 8 }).fontColor('#666')
    }
    .width('25%')
    .onClick(() => {
      if (name === 'åŸŽå¸‚å°è±¡') {
        router.pushUrl({ url: 'pages/features/DataDetailView', params: { title: name, cityName: this.currentCity, color: color, icon: icon } });
      } else if (isAll || name === 'å…¨éƒ¨') {
        router.pushUrl({ url: 'pages/features/AllFunctionsView' });
      } else if (name === 'éšæ‰‹ç¬”è®°') {
        router.pushUrl({ url: 'pages/features/NoteView'})
      } else if (name === 'åŽ†å²è½´çº¿') {
        router.pushUrl({ url: 'pages/features/CityHistoryPage', params: { title: name, cityName: this.currentCity, color: color, icon: icon } });
      } else if (name === 'åŸŽå¸‚åäºº') {
        router.pushUrl({ url: 'pages/features/CityCelebrityPage', params: { title: name, cityName: this.currentCity, color: color, icon: icon }});
      } else if (name === 'è¡Œç¨‹å®‰æŽ’') {
        router.pushUrl({ url: 'pages/features/ScheduleView'})
      } else {
        promptAction.showToast({ message: `${name} åŠŸèƒ½å¼€å‘ä¸­...` });
      }
    })
  }

  @Builder TopicItem(title: string, count: string, color: string) {
    Column() {
      Text(`# ${title}`).fontSize(14).fontWeight(FontWeight.Bold).fontColor('#333')
      Text(`${count} å‚ä¸Žè®¨è®º`).fontSize(11).fontColor('#666').margin({ top: 6 })
    }
    .width(140).height(70).padding(12).backgroundColor(color).borderRadius(12)
    .alignItems(HorizontalAlign.Start).justifyContent(FlexAlign.Center)
  }

  @Builder SectionHeader(title: string) {
    Row() {
      Text(title).fontSize(18).fontWeight(FontWeight.Bold)
      Blank()
      Text('æ›´å¤š >').fontSize(12).fontColor('#999')
    }.width('100%').margin({ bottom: 15 })
  }

  @Builder NewRouteCard(route: TravelRoute) {
    Row() {
      Column() {
        Circle({ width: 6, height: 6 }).fill('#007DFF')
        Rect().width(1).height(15).fill('#D8D8D8')
        Circle({ width: 6, height: 6 }).fill(Color.Transparent).stroke('#007DFF').strokeWidth(1)
      }.margin({ right: 12 })
      Column() {
        Text(route.routeName).fontSize(15).fontWeight(FontWeight.Bold)
        Text(`${route.spots.length}ä¸ªæ‰“å¡ç‚¹ Â· å»ºè®®æ—¶é—´${route.spots.length > 3 ? '1å¤©' : 'åŠå¤©'}`)
          .fontSize(12).fontColor('#666').margin({ top: 4 })
      }.layoutWeight(1).alignItems(HorizontalAlign.Start)

      Button('åŒæ­¥è¡Œç¨‹').height(28).fontSize(11).backgroundColor('#007DFF')
        .onClick(() => {
          // âœ… API 21 æ­£ç¡®å†™æ³•ï¼šç¡®ä¿å‚æ•°å¯¹è±¡ç¬¦åˆ router.RouterOptions
          const options: router.RouterOptions = {
            url: 'pages/features/TravelScheduleView',
            params: {
              'route': route,
              'cityName': this.currentCity
            }
          };
          router.pushUrl(options);
        })
    }
    .width('100%').padding(15).backgroundColor('#FFFFFF').borderRadius(12).margin({ bottom: 10 })
    .onClick(() => {
      const options: router.RouterOptions = {
        url: 'pages/features/TravelScheduleView',
        params: {
          'route': route,
          'cityName': this.currentCity
        }
      };
      router.pushUrl(options);
    })
  }

  jumpToGuide(route: TravelRoute) {
    router.pushUrl({
      url: 'pages/guide/GuideView',
      params: { route: route }
    }, (err) => {
      if (err) promptAction.showToast({ message: `è·³è½¬å¤±è´¥: ${err.message}` });
    })
  }
}