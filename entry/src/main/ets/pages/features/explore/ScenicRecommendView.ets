import { http } from '@kit.NetworkKit'
import { AmapSpotService, ScenicSpot } from '../../../services/AmapSpotService'
import { router, promptAction } from '@kit.ArkUI'

interface AIMessage { content: string; role: string; }
interface AIChoice { message: AIMessage; }
interface AIResponse { choices: AIChoice[] }

interface AIChatItem { role: 'user' | 'assistant', content: string }

interface ScenicUIItem {
  id: string
  name: string
  cover: string
  rating: number
  heatLevel?: 'low' | 'mid' | 'high'
  tags: string[]
  price?: string
  bookable?: boolean
  isAClass?: boolean
  address: string
  opacity: number
  translateY: number
}

@Entry
@Component
struct ScenicRecommendView {
  @StorageLink('currentCity') cityName: string = 'åŒ—äº¬å¸‚'
  @State currentCategory: string = 'å…¨éƒ¨'
  @State searchKeyword: string = ''
  // ğŸ”¹ ä¿®æ”¹1ï¼šåˆ†ç±»å·²ç²¾ç®€ï¼Œåˆ é™¤äº†â€œä¸€æ—¥è·¯çº¿â€
  @State categories: string[] = ['å…¨éƒ¨', 'äººæ–‡', 'è‡ªç„¶']
  @State scenicList: ScenicUIItem[] = []
  @State bgBaseColor: string = '#F6F7F9'
  @State locationTips: string = 'æ­£åœ¨ä¸ºæ‚¨å¯»è§…åŸä¸­çš„è¯—æ„...'
  @State aiChats: AIChatItem[] = []
  @State showAI: boolean = false
  @State aiQuery: string = ''
  @State aiLoading: boolean = false
  @State filteredList: ScenicUIItem[] = [];

  private static lastYOffset: number = 0
  private scroller: Scroller = new Scroller()
  private aiScroller: Scroller = new Scroller();
  private lastCityLoaded: string = '';

  private aiTimer: number = -1;
  private searchTimer: number = -1;

  // ğŸ”¹ ä¿®æ”¹2ï¼šä¿®å¤åçš„å¹³å°é€‰æ‹©é€»è¾‘ (ä½¿ç”¨ ActionSheet å®˜æ–¹è§„èŒƒ)
  private showPlatformSelector(item: ScenicUIItem) {
    ActionSheet.show({
      title: `é¢„è®¢ ${item.name}`,
      message: 'è¯·é€‰æ‹©æ‚¨åå¥½çš„é¢„è®¢å¹³å°',
      autoCancel: true,
      alignment: DialogAlignment.Bottom,
      offset: { dx: 0, dy: -20 },
      sheets: [
        {
          title: 'æºç¨‹æ—…è¡Œ',
          action: () => {
            promptAction.showToast({ message: 'æ­£åœ¨è·³è½¬æºç¨‹...' });
          }
        },
        {
          title: 'ç¾å›¢ / ç‚¹è¯„',
          action: () => {
            promptAction.showToast({ message: 'æ­£åœ¨è·³è½¬ç¾å›¢...' });
          }
        },
        {
          title: 'é«˜å¾·åœ°å›¾',
          action: () => {
            promptAction.showToast({ message: 'æ­£åœ¨è·³è½¬é«˜å¾·...' });
          }
        }
      ],
      confirm: {
        value: 'å–æ¶ˆ',
        action: () => {}
      }
    })
  }

  private getSortedScenicList(): ScenicUIItem[] {
    return this.scenicList
      .filter(item => {
        if (this.searchKeyword) {
          const kw = this.searchKeyword.trim();
          const matchName = item.name.includes(kw);
          const matchTags = item.tags.some(tag => tag.includes(kw));
          const matchAddress = item.address.includes(kw);
          if (!matchName && !matchTags && !matchAddress) {
            return false;
          }
        }
        if (this.currentCategory === 'å…¨éƒ¨') return true;
        if (this.currentCategory === 'äººæ–‡') return item.tags.includes('äººæ–‡');
        if (this.currentCategory === 'è‡ªç„¶') {
          const natureKeywords = ['å…¬å›­', 'å±±', 'æ¹–', 'æ°´', 'æ—', 'å²›', 'è‡ªç„¶', 'éƒŠé‡', 'æ»©'];
          const hasNatureTag = item.tags.includes('è‡ªç„¶') || item.tags.includes('é£æ™¯åŒº');
          const hasNatureName = natureKeywords.some(key => item.name.includes(key));
          return hasNatureTag || hasNatureName;
        }
        return true;
      })
      .sort((a, b) => this.calcHeat(b) - this.calcHeat(a));
  }

  private async askAI(query: string) {
    if (!query.trim() || this.aiLoading) return;

    this.aiChats.push({ role: 'user', content: query });
    this.scrollAIToBottom();
    this.aiQuery = '';
    this.aiLoading = true;
    this.showAI = true;
    this.trimChats();

    const token = '82e4d46a05264dd19a27e1d91b30dce6.UNpMhFWNznhFSPLo';
    let httpRequest = http.createHttp();

    try {
      const response = await httpRequest.request('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
        method: http.RequestMethod.POST,
        header: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        extraData: {
          model: 'glm-4-flash',
          messages: [
            { role: 'system', content: 'ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½æ–‡æ—…çš„æ™ºè€…ï¼Œè¯·ç”¨æ–‡é›…ä¸”å¯Œæœ‰è¯—æ„çš„è¯­è¨€å›ç­”ï¼Œä¸¥æ ¼æ§åˆ¶åœ¨200å­—ä»¥å†…ã€‚' },
            ...this.aiChats
          ]
        }
      });
      const res = JSON.parse(response.result as string) as AIResponse;
      let content = res.choices[0].message.content;
      if (content.length > 200) {
        content = content.slice(0, 200) + '...';
      }
      this.aiChats.push({ role: 'assistant', content });
    } catch (e) {
      this.aiChats.push({ role: 'assistant', content: 'çµçŠ€ä¸­æ–­ï¼Œè¯·ç¨åå†è¯•ã€‚' });
    }
    this.aiLoading = false;
    this.scrollAIToBottom();
  }

  private calcHeat(item: ScenicUIItem): number {
    let score = 0;
    if (item.tags.includes('5Aæ™¯åŒº')) score += 50;
    else if (item.tags.includes('4Aæ™¯åŒº')) score += 35;
    else if (item.tags.includes('3Aæ™¯åŒº')) score += 20;
    score += item.rating * 6;
    score += item.tags.length * 2;
    if (!item.price || item.price === '0') score += 6;
    if (item.name.length <= 4) score -= 5;
    return score;
  }

  private getThemeColor(category: string): string {
    const colorMap: Record<string, string> = {
      'å…¨éƒ¨': '#F6F7F9', 'äººæ–‡': '#FCF6ED', 'è‡ªç„¶': '#F0F9F4'
    }
    return colorMap[category] || '#F6F7F9'
  }

  private scrollAIToBottom() {
    clearTimeout(this.aiTimer);
    this.aiTimer = setTimeout(() => {
      this.aiScroller.scrollEdge(Edge.Bottom);
    }, 120);
  }

  private trimChats() {
    const MAX = 6;
    if (this.aiChats.length > MAX) {
      this.aiChats.splice(0, this.aiChats.length - MAX);
    }
  }

  private async loadSpots() {
    try {
      if (this.lastCityLoaded === this.cityName && this.scenicList.length > 0) {
        return;
      }
      this.lastCityLoaded = this.cityName;
      const spots = await AmapSpotService.fetchSpots(this.cityName);
      const mapped = spots.map((s: ScenicSpot): ScenicUIItem => {
        const tags = [...s.tags];
        if (!s.price || s.price === '0' || s.price === '[]') {
          if (!tags.includes('å…è´¹')) tags.push('å…è´¹');
        }
        return {
          id: s.id,
          name: s.name,
          cover: s.image,
          rating: parseFloat(s.rating || '0'),
          tags,
          price: (s.price === '0' || !s.price || s.price === '[]') ? undefined : s.price,
          address: s.address,
          opacity: 0,
          translateY: 40
        };
      });

      this.scenicList = mapped;
      this.filteredList = this.getSortedScenicList();
      this.playEnterAnimation();
    } catch (e) {
      promptAction.showToast({ message: 'æ™¯ç‚¹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' });
    }
  }

  private playEnterAnimation() {
    const listCount = this.scenicList.length;
    this.scenicList.forEach((_, index) => {
      animateTo(
        { duration: 600, delay: index * 100, curve: Curve.EaseOut },
        () => {
          if (index < listCount && this.scenicList[index]) {
            this.scenicList[index].opacity = 1;
            this.scenicList[index].translateY = 0;
          }
        }
      );
    });
  }

  async aboutToAppear() {
    await this.loadSpots();
  }

  async onPageShow() {
    await this.loadSpots();
  }

  onPageHide() {
    ScenicRecommendView.lastYOffset = this.scroller.currentOffset().yOffset;
  }

  aboutToDisappear() {
    clearTimeout(this.aiTimer);
    clearTimeout(this.searchTimer);
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        this.TopBar()
        Search({ placeholder: 'æœç´¢åŸä¸­èƒœæ™¯ã€åœ°æ ‡...', value: this.searchKeyword })
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })
          .height(44)
          .onChange(v => {
            clearTimeout(this.searchTimer);
            this.searchTimer = setTimeout(() => {
              this.searchKeyword = v;
              this.filteredList = this.getSortedScenicList();
            }, 300);
          })

        this.CategoryBar()

        Scroll(this.scroller) {
          Column({ space: 25 }) {
            if (this.getSortedScenicList().length === 0) {
              Column({ space: 10 }) {
                Image($r('app.media.ic_ai_chat')).width(100).opacity(0.3)
                Text('æœªæ‰¾åˆ°ç›¸å…³èƒœæ™¯').fontColor('#999').fontSize(14)
              }.width('100%').margin({ top: 100 })
            }

            this.VenueEntryCard()

            ForEach(this.getSortedScenicList(),
              (item: ScenicUIItem, index: number) => {
                this.ScenicCard(item, index)
              },
              (item: ScenicUIItem) => item.id + this.currentCategory
            )
          }
          .padding({ left: 16, right: 16, bottom: 100 })
        }
        .layoutWeight(1)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')
      .linearGradient({
        angle: 180,
        colors: [[this.bgBaseColor, 0], ['#FFFFFF', 1.0]]
      })

      Button() { Image($r('app.media.ic_ai_chat')).width(30).height(30) }
      .width(60).height(60).borderRadius(30).backgroundColor('#2C3E50').margin({ right: 20, bottom: 40 })
      .onClick(() => {
        this.showAI = true;
      })

      if (this.showAI) this.AIPanel()
    }
  }

  @Builder TopBar() {
    Row({ space: 12 }) {
      SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(24).fontColor(['#111'])
        .onClick(() => router.back())
      Column({ space: 2 }) {
        Row({ space: 4 }) {
          Text(this.cityName).fontSize(18).fontWeight(FontWeight.Bold)
          SymbolGlyph($r('sys.symbol.location_north_up_right_and_circle_dotted_fill')).fontSize(14)
        }
        Text(this.locationTips).fontSize(10).fontColor('#7F8C8D').fontStyle(FontStyle.Italic)
      }.alignItems(HorizontalAlign.Start)
      Blank()
    }.width('100%').padding(16)
  }

  @Builder CategoryBar() {
    Scroll() {
      Row({ space: 20 }) {
        ForEach(this.categories, (item: string) => {
          Column() {
            Text(item)
              .fontSize(this.currentCategory === item ? 17 : 15)
              .fontWeight(this.currentCategory === item ? FontWeight.Bold : FontWeight.Regular)
              .fontColor(this.currentCategory === item ? '#111' : '#999')
            if (this.currentCategory === item) {
              Rect().width(20).height(3).fill('#2C3E50').margin({ top: 4 }).borderRadius(2)
            }
          }
          .padding({ left: 10, right: 10 })
          .onClick(() => {
            this.scroller.scrollTo({ xOffset: 0, yOffset: 0 });
            animateTo({ duration: 400, curve: Curve.Sharp }, () => {
              this.currentCategory = item
              this.bgBaseColor = this.getThemeColor(item)
              this.filteredList = this.getSortedScenicList();
            })
          })
        }, (item: string) => item)
      }.padding({ left: 16, right: 16 })
    }.scrollBar(BarState.Off).margin({ top: 10, bottom: 15 })
  }

  @Builder VenueEntryCard() {
    Row() {
      Column({ space: 6 }) {
        Text('åŸå¸‚åœºé¦†é¢„çº¦').fontSize(20).fontWeight(FontWeight.Bolder).fontColor('#FFF')
        Text('è®©æ¯ä¸€æ¬¡å‡ºè¡Œéƒ½å……æ»¡äººæ–‡ä»ªå¼æ„Ÿ').fontSize(12).fontColor('rgba(255,255,255,0.8)')
      }.alignItems(HorizontalAlign.Start)
      Blank()
      SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(18).fontColor(['#FFF'])
    }
    .width('100%').padding(26).borderRadius(32).margin({ bottom: 10 })
    .linearGradient({ angle: 135, colors: [['#667eea', 0], ['#764ba2', 0.5], ['#ff9a9e', 1]] })
    .shadow({ radius: 20, color: 'rgba(118,75,162,0.3)', offsetY: 10 })
    .onClick(() => router.pushUrl({ url: 'pages/features/explore/VenueBookingView' }))
  }

  @Builder ScenicCard(item: ScenicUIItem, index?: number){
    Column() {
      Stack({ alignContent: Alignment.TopEnd }) {
        Image(item.cover).width('100%').height(260).borderRadius(24).objectFit(ImageFit.Cover)

        Row() {
          Text('â˜…').fontColor('#FFD700').fontSize(12)
          Text(item.rating.toFixed(1)).fontColor(Color.White).fontSize(14).fontWeight(FontWeight.Bold).margin({ left: 4 })
        }
        .padding({ left: 10, right: 12, top: 6, bottom: 6 })
        .backgroundColor('rgba(0,0,0,0.5)')
        .borderRadius({ topLeft: 24, bottomRight: 18 })
        .position({ x: 0, y: 0 })

        Button('AI å¯¼è¯»')
          .fontSize(12)
          .height(30)
          .backgroundColor('rgba(0,0,0,0.6)')
          .margin({ top: 12, right: 12 })
          .onClick(() => this.askAI(`è¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹${item.name}çš„å†å²æ¸Šæºå’Œç‰¹è‰²æ™¯è§‚ã€‚`))
      }

      Row() {
        Column({ space: 4 }) {
          Text(item.name).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#2C3E50')
          Row({ space: 6 }) {
            if (item.tags.includes('å…è´¹')) {
              Text('FREE')
                .fontSize(10)
                .fontColor('#00A86B')
                .backgroundColor('#E8FFF3')
                .borderRadius(6)
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            }
            if (item.tags.includes('5Aæ™¯åŒº')) {
              Text('5A')
                .fontSize(10).fontColor('#FF7A45').backgroundColor('#FFF2E8').borderRadius(6)
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            }
          }
          Text(item.address).fontSize(12).fontColor('#7F8C8D').maxLines(1)
        }.alignItems(HorizontalAlign.Start).layoutWeight(1)

        Button() {
          Row({ space: 4 }) {
            Text(item.price ? `Â¥${item.price}` : 'å…è´¹')
              .fontSize(16)
              .fontWeight(FontWeight.Bolder)
              .fontColor(Color.White)
            Text(item.price ? 'èµ·' : 'é¢„è®¢').fontSize(12).fontColor(Color.White)
          }
        }
        .height(38)
        .padding({ left: 15, right: 15 })
        .linearGradient({ angle: 135, colors: [['#FF9A9E', 0], ['#FAD0C4', 1]] })
        .borderRadius(19)
        .onClick(() => {
          this.showPlatformSelector(item)
        })
      }.width('100%').padding({ top: 15, bottom: 10 })
    }
    .opacity(item.opacity)
    .translate({ y: item.translateY })
    .margin({ bottom: 10 })
  }

  @Builder AIPanel() {
    Column() {
      Row() {
        Text('å¯»åŸŸç™¾ç§‘').fontWeight(FontWeight.Bold).fontColor('#C9A25D').fontSize(18)
        Blank()
        SymbolGlyph($r('sys.symbol.xmark'))
          .fontSize(20)
          .fontColor(['#999'])
          .onClick(() => this.showAI = false)
      }.width('100%').padding(20).border({ width: { bottom: 1 }, color: '#F5F5F5' })

      List({ space: 16, scroller: this.aiScroller }) {
        ForEach(this.aiChats, (chat: AIChatItem) => {
          ListItem() {
            Row() {
              if (chat.role === 'user') Blank()
              Column() {
                Text(chat.content)
                  .padding(12)
                  .borderRadius(12)
                  .backgroundColor(chat.role === 'user' ? '#007DFF' : '#F4F4F4')
                  .fontColor(chat.role === 'user' ? Color.White : '#333')
                  .fontSize(15)
                  .lineHeight(24)
              }.constraintSize({ maxWidth: '80%' })
              if (chat.role === 'assistant') Blank()
            }.width('100%')
          }
        })
        if (this.aiLoading) {
          ListItem() {
            LoadingProgress().width(32).height(32).margin({ left: 20 })
          }
        }
      }
      .layoutWeight(1)
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .width('100%')
      .edgeEffect(EdgeEffect.Spring)

      Row({ space: 10 }) {
        TextInput({ text: this.aiQuery, placeholder: 'åœ¨æ­¤è¾“å…¥æ‚¨çš„è¿½é—®...' })
          .layoutWeight(1)
          .height(42)
          .backgroundColor('#F5F5F5')
          .onChange(v => this.aiQuery = v)
          .onSubmit(() => this.askAI(this.aiQuery))

        Button('å‘é€')
          .height(42)
          .backgroundColor('#C9A25D')
          .fontColor(Color.White)
          .onClick(() => this.askAI(this.aiQuery))
      }
      .padding({ left: 20, right: 20, bottom: 20, top: 10 })
      .width('100%')
    }
    .width('100%')
    .height('60%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 28, topRight: 28 })
    .shadow({ radius: 40, color: 'rgba(0,0,0,0.15)' })
  }
}