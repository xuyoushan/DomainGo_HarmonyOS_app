// entry/src/main/ets/pages/DataDetailView.ets
import { router } from '@kit.ArkUI';
import { util } from '@kit.ArkTS';
import { textToSpeech } from '@kit.CoreSpeechKit'; // ğŸ”¹ 1. å¼•å…¥è¯­éŸ³å¥—ä»¶
import { promptAction } from '@kit.ArkUI'; // ğŸ”¹ ç»Ÿä¸€ä½¿ç”¨ kit å¼•å…¥
import { BusinessError } from '@kit.BasicServicesKit'; // ğŸ”¹ å¿…åŠ ï¼šä¿®å¤ TTS ä¸å“åº”çš„å…³é”®
import type common from '@ohos.app.ability.common';

interface DetailParam {
  title: string;
  cityName: string;
  color: string;
  icon: Resource;
}

interface ArticleItem {
  title: string;
  author: string;
  content: string;
}

interface CityStyle {
  theme: string;
  accent: string;
  file: string;
}

const CITY_STYLES: Record<string, CityStyle> = {
  "åŒ—äº¬": { theme: "#FDF6E3", accent: "#B58900", file: "beijing.md" },
  "å¤©æ´¥": { theme: "#F5F7FA", accent: "#005BB7", file: "tianjin.md" },
  "ä¸Šæµ·": { theme: "#F2F2F2", accent: "#A52A2A", file: "shanghai.md" },
  "æ­¦æ±‰": { theme: "#FDF5E6", accent: "#E64340", file: "wuhan.md" },
  "é‡åº†": { theme: "#F0F0F0", accent: "#2F4F4F", file: "chongqing.md" },
  "æˆéƒ½": { theme: "#F7F9F2", accent: "#1B5E20", file: "chengdu.md" }
};

@Entry
@Component
struct DataDetailView {
  @State params: DetailParam | null = null;
  @State isPlaying: boolean = false;
  @State articleList: ArticleItem[] = [];
  @State themeColor: string = "#FDF6E3";
  @State accentColor: string = "#B58900";
  @State loadingStatus: string = "æ­£åœ¨è¯»å–æ–‡ç« å†…å®¹...";

  // ğŸ”¹ 2. æœ—è¯»ç›¸å…³ç§æœ‰å˜é‡
  private ttsEngine?: textToSpeech.TextToSpeechEngine;
  @State currentSwiperIndex: number = 0; // è®°å½•å½“å‰åœ¨çœ‹å“ªä¸€ç¯‡

  aboutToAppear() {
    this.params = router.getParams() as DetailParam;
    this.loadArticleContent();
    this.initTts(); // ğŸ”¹ 3. åˆå§‹åŒ–TTS
  }

  // ğŸ”¹ 4. é‡Šæ”¾èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼å’Œå£°éŸ³å…³ä¸æ‰
  aboutToDisappear() {
    if (this.ttsEngine) {
      this.ttsEngine.stop();
      this.ttsEngine.shutdown();
    }
  }

  // ğŸ”¹ 5. åˆå§‹åŒ–TTSå¼•æ“é€»è¾‘
  initTts() {
    try {
      let initParamsInfo: textToSpeech.CreateEngineParams = {
        language: 'zh-CN',
        person: 0,
        online: 1,
        extraParams: { 'style': 'interaction' }
      };
      textToSpeech.createEngine(initParamsInfo, (err: BusinessError, engine: textToSpeech.TextToSpeechEngine) => {
        if (!err) {
          this.ttsEngine = engine;
          this.ttsEngine.setListener({
            onStart: () => { this.isPlaying = true; },
            onComplete: () => { this.isPlaying = false; },
            onStop: () => { this.isPlaying = false; },
            onError: () => { this.isPlaying = false; }
          });
        }
      });
    } catch (e) {
      console.error('TTS Init Failed', JSON.stringify(e));
    }
  }

  // ğŸ”¹ 6. æœ—è¯»/åœæ­¢é€»è¾‘
  handleSpeech() {
    if (!this.ttsEngine) {
      promptAction.showToast({ message: 'è¯­éŸ³å¼•æ“åˆå§‹åŒ–ä¸­...' });
      return;
    }
    if (this.isPlaying) {
      this.ttsEngine.stop();
    } else {
      const currentArticle = this.articleList[this.currentSwiperIndex];
      if (currentArticle) {
        // æœ—è¯» æ ‡é¢˜ + ä½œè€… + æ­£æ–‡å†…å®¹
        let textToRead = `${currentArticle.title}ã€‚ä½œè€…ï¼š${currentArticle.author}ã€‚${currentArticle.content}`;
        let speakParams: textToSpeech.SpeakParams = {
          requestId: Date.now().toString(),
          extraParams: { 'speed': 1.0, 'volume': 1.0, 'pitch': 1.0 }
        };
        this.ttsEngine.speak(textToRead, speakParams);
      }
    }
  }

  async loadArticleContent() {
    this.articleList = [];
    const cityName = this.params?.cityName || "";
    const context = getContext(this) as common.UIAbilityContext;

    // åŒ¹é…åŸå¸‚é…ç½®
    const cityKey = Object.keys(CITY_STYLES).find(k => cityName.includes(k));
    const config = cityKey ? CITY_STYLES[cityKey] : null;

    if (config) {
      this.themeColor = config.theme;
      this.accentColor = config.accent;
      try {
        const uint8arr = await context.resourceManager.getRawFileContent(config.file);
        this.processRawText(uint8arr);
      } catch (e) {
        this.loadingStatus = `ã€Š${cityName}ã€‹å†…å®¹æ­£åœ¨æ•´ç†ä¸­...`;
      }
    } else {
      this.loadingStatus = `æ­£åœ¨è¿›å…¥${cityName}é¢‘é“...`;
    }
  }

  // æ–°å¢ä¸€ä¸ªè§£ç ä¸­è½¬å‡½æ•°ï¼Œä¿æŒ parseMarkdown é€»è¾‘çº¯å‡€
  processRawText(uint8arr: Uint8Array) {
    const textDecoder = util.TextDecoder.create('utf-8');
    const rawText: string = textDecoder.decodeWithStream(uint8arr);
    this.parseMarkdown(rawText);
  }

  parseMarkdown(allText: string) {
    const parts = allText.split(/##|ç¬¬[ä¸€äºŒ]ç¯‡æ–‡ç« ï¼š/);
    const authors = ["éƒè¾¾å¤«", "è€èˆ", "å†¯éª¥æ‰", "å†¯å…´ä¸œ", "èŒ…ç›¾", "ç‹å¿—çº²", "æ± è‰", "æ˜“ä¸­å¤©", "æœ±è‡ªæ¸…", "ä¸°å­æº", "ä½•å…¶èŠ³"];

    this.articleList = parts.filter(p => p.trim()).map((part): ArticleItem => { // ğŸ”¹ è¿™é‡Œæ˜¾å¼åŠ ä¸Š : ArticleItem
      const lines = part.trim().split('\n');
      const title = lines[0].replace(/#/g, '').trim();
      const content = part.trim().substring(part.trim().indexOf('\n')).trim();
      const foundAuthor = authors.find(a => part.includes(a));

      // ğŸ”¹ è¿”å›æ—¶ç¡®ä¿å­—æ®µå®Œå…¨åŒ¹é…æ¥å£
      return {
        title: title,
        author: foundAuthor || "åå®¶æ•£æ–‡",
        content: content
      };
    });
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Stack() {
          Circle({ width: 36, height: 36 }).fill('#1A000000')
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(22)
            .fontColor(['#333333'])
        }
        .onClick(() => router.back())

        Text(this.params?.cityName || "åŸå¸‚å°è±¡")
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 12 })

        Blank()

        Row() {
          SymbolGlyph(this.isPlaying ? $r('sys.symbol.pause_fill') : $r('sys.symbol.play_fill'))
            .fontSize(20)
            .fontColor([this.accentColor])
          Text(this.isPlaying ? ' åœæ­¢' : ' æœ—è¯»')
            .fontSize(14)
            .fontColor(this.accentColor)
            .margin({ left: 4 })
        }
        .padding({ left: 15, right: 15, top: 8, bottom: 8 })
        .borderRadius(25)
        .backgroundColor('#1A000000')
        .onClick(() => this.handleSpeech())
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 45, bottom: 15 })
      .backgroundColor(this.themeColor)

      // --- å®šä½é€»è¾‘åˆ¤æ–­æ˜¾ç¤º ---
      if (this.articleList.length === 0) {
        Column({ space: 20 }) {
          LoadingProgress().width(40).color('#999')
          Text(this.loadingStatus)
            .fontColor('#999')
            .fontSize(16)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .width('100%')
      } else {
        Swiper() {
          ForEach(this.articleList, (item: ArticleItem) => {
            Scroll() {
              Column() {
                Text(item.title)
                  .fontSize(28)
                  .fontWeight(FontWeight.Bolder)
                  .margin({ top: 20 })

                Text(`${item.author} | åŸå¸‚å°è±¡`)
                  .fontSize(14)
                  .fontColor('#666')
                  .margin({ top: 10, bottom: 35 })

                if (item.content.length > 0) {
                  // --- è§£å†³é¦–å­—é®æŒ¡æ–¹æ¡ˆï¼šä½¿ç”¨ç›¸å¯¹å®šä½é¿è®© ---
                  Stack({ alignContent: Alignment.TopStart }) {
                    // å¤§å­—åº•éƒ¨æ˜¾ç¤º
                    Text(item.content.charAt(0))
                      .fontSize(60)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(this.accentColor)
                      .margin({ top: -5 }) // å‘ä¸Šå¾®è°ƒï¼Œè§†è§‰å¯¹é½

                    Text() {
                      // è¿™é‡Œçš„ç©ºSpané…åˆæ–‡å­—é¦–è¡Œç¼©è¿›ï¼Œå½»åº•è§£å†³é‡å 
                      Span('                 \n          ')
                      Span(item.content.substring(1))
                        .fontSize(19)
                        .lineHeight(38)
                        .fontColor('#2C2C2C')
                    }
                   .textAlign(TextAlign.JUSTIFY)
                  }
                }
                Divider().color('#1A000000').margin({ top: 50, bottom: 50 })
              }
              .alignItems(HorizontalAlign.Start)
              .padding({ left: 25, right: 25 })
            }
          })
        }
        .loop(false)
        .indicator(true)
        .layoutWeight(1)
        .onChange((index: number) => {
          this.currentSwiperIndex = index;
          if (this.isPlaying && this.ttsEngine) {
            this.ttsEngine.stop();
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeColor)
  }
}