import { router } from '@kit.ArkUI';
import { CITY_TOOLKIT_CONFIG, DEFAULT_TOOLKIT_DATA, ToolkitTip } from '../../../models/CityToolkitData';

@Entry
@Component
struct CityToolkitView {
  @StorageLink('currentCity') currentCity: string = 'æ­¦æ±‰å¸‚';
  @State activeIndex: number = 0;

  build() {
    Stack() {
      // 1. åŠ¨æ€åº•è‰²ï¼ˆéšå¡ç‰‡ä¸»é¢˜è‰²åˆ‡æ¢ï¼Œå¢åŠ æ²‰æµ¸æ„Ÿï¼‰
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(this.getCurrentColor())
        .animation({ duration: 500 })

      // èƒŒæ™¯è£…é¥°æ–‡å­—
      Text(this.currentCity)
        .fontSize(150)
        .fontWeight(FontWeight.Bolder)
        .fontColor('rgba(255,255,255,0.05)')
        .position({ x: -20, y: 100 })

      Column() {
        // --- é¡¶éƒ¨çŠ¶æ€ ---
        this.Header()

        // 2. æ ¸å¿ƒï¼šæ¨ªå‘å †å è½®æ’­ï¼ˆè®©æ•°æ®â€œæ˜¾å¾—â€æ— ç©·æ— å°½ï¼‰
        Swiper() {
          ForEach(CITY_TOOLKIT_CONFIG[this.currentCity] || DEFAULT_TOOLKIT_DATA, (item: ToolkitTip) => {
            this.InteractiveCard(item)
          })
        }
        .width('100%')
        .height('70%')
        .loop(true)
        .indicator(false)
        .displayMode(SwiperDisplayMode.STRETCH)
        .effectMode(EdgeEffect.Spring)
        .itemSpace(20)
        .prevMargin(30)
        .nextMargin(30)
        .onChange((index) => this.activeIndex = index)

        // 3. åº•éƒ¨é¡µç æŒ‡ç¤ºï¼ˆå¢åŠ ä¹¦å·æ„Ÿï¼‰
        Text(`${this.activeIndex + 1} / ${(CITY_TOOLKIT_CONFIG[this.currentCity] || DEFAULT_TOOLKIT_DATA).length}`)
          .fontColor('rgba(255,255,255,0.6)')
          .fontSize(14)
          .margin({ top: 30 })
          .fontFamily('Monospace')
      }
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  // æ˜ç¡®æŒ‡å®šè¿”å›ç±»å‹ä¸º string
  getCurrentColor(): string {
    // 1. è·å–å¯¹åº”åŸå¸‚çš„æ•°æ®æ•°ç»„ï¼Œå¹¶æ˜ç¡®å…¶ç±»å‹ä¸º ToolkitTip[]
    const data: ToolkitTip[] = CITY_TOOLKIT_CONFIG[this.currentCity] || DEFAULT_TOOLKIT_DATA;

    // 2. æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢è¶Šç•Œæˆ– undefined
    if (data && data.length > this.activeIndex) {
      const item: ToolkitTip = data[this.activeIndex];
      return item.color;
    }

    // 3. å…œåº•è¿”å›ä¸€ä¸ªé»˜è®¤é¢œè‰²
    return '#333333';
  }

  @Builder Header() {
    Row() {
      SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(24).fontColor(['#FFF'])
        .onClick(() => router.back())
      Blank()
      Text('UNBOXING CITY').fontSize(12).fontColor('rgba(255,255,255,0.5)').letterSpacing(2)
    }
    .width('100%')
    .padding({ left: 30, right: 30, top: 60 })
    .position({ y: 0 })
  }

  @Builder InteractiveCard(item: ToolkitTip) {
    Column() {
      // å¡ç‰‡é¡¶éƒ¨ï¼šåƒæ¡£æ¡ˆå¤¹ä¸€æ ·çš„æ ‡ç­¾
      Row() {
        Text(item.title).fontSize(14).fontWeight(FontWeight.Bold).fontColor('#FFF')
          .padding({ left: 10, right: 10, top: 4, bottom: 4 })
          .backgroundColor('rgba(255,255,255,0.1)')
          .borderRadius(4)
      }.width('100%').margin({ bottom: 40 })

      // å¤§å›¾æ ‡
      SymbolGlyph(item.icon).fontSize(80).fontColor(['#FFF']).margin({ bottom: 30 })
        .shadow({ radius: 20, color: 'rgba(0,0,0,0.2)' })

      // ä¸»è¯æ¡
      Text(item.mainInfo)
        .fontSize(28)
        .fontWeight(FontWeight.Bolder)
        .fontColor('#FFF')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 10 })

      Text(item.subInfo)
        .fontSize(16)
        .fontColor('rgba(255,255,255,0.7)')
        .margin({ bottom: 40 })

      // ğŸ’¡ è¿™é‡Œçš„â€œå±•å¼€â€é€»è¾‘ï¼šå¹³æ—¶åªæ˜¾ç¤ºä¸€ç‚¹ç‚¹ï¼Œè¯±å¯¼ç”¨æˆ·
      Column() {
        Text('ã€Œ çµé­‚å¤‡æ³¨ ã€')
          .fontSize(12)
          .fontColor('rgba(255,255,255,0.4)')
          .margin({ bottom: 10 })

        Scroll() {
          Text(item.crazyNote)
            .fontSize(16)
            .fontColor('#FFF')
            .lineHeight(26)
            .textAlign(TextAlign.Center)
        }
        .layoutWeight(1)
      }
      .width('100%')
      .layoutWeight(1)
      .padding(20)
      .backgroundColor('rgba(0,0,0,0.15)')
      .borderRadius(15)
    }
    .width('100%')
    .height('100%')
    .padding(30)
    .backgroundColor('rgba(255,255,255,0.1)')
    .backgroundBlurStyle(BlurStyle.Thin) // ç£¨ç ‚ç»ç’ƒ
    .borderRadius(30)
    .border({ width: 1, color: 'rgba(255,255,255,0.2)' })
  }
}