import { router, promptAction } from '@kit.ArkUI';
import http from '@ohos.net.http';

interface AmapPoi {
  name: string;
  address: string;
  adname: string;
}
interface AmapResponse {
  status: string;
  pois: AmapPoi[];
}

@Entry
@Component
struct TravelServiceView {
  @StorageLink('currentCity') currentCity: string = 'æ­¦æ±‰å¸‚';
  @State selectedIndex: number = 2; // é»˜è®¤åˆ‡åˆ°äº¤é€šï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
  @State destination: string = '';
  @State hotelKeyword: string = '';

  // äº¤é€šæ¨¡å—çŠ¶æ€
  @State searchResults: AmapPoi[] = [];
  @State isShowPlatforms: boolean = false;
  @State currentMode: string = '';
  @State activePlatforms: string[] = []; // åŠ¨æ€å­˜æ”¾å½“å‰æ¨¡å¼ä¸‹çš„å¹³å°åˆ—è¡¨

  aboutToAppear() {
    let params = router.getParams() as Record<string, string>;
    if (params) {
      if (params.defaultType === 'é—¨ç¥¨é¢„è®¢') this.selectedIndex = 0;
      if (params.defaultType === 'é…’åº—ä½å®¿') this.selectedIndex = 1;
      if (params.defaultType === 'äº¤é€šå‡ºè¡Œ') this.selectedIndex = 2;
    }
  }

  // --- 1. é«˜å¾·æœç´¢é€»è¾‘ ---
  async searchPoi(keyword: string) {
    if (!keyword) {
      this.searchResults = [];
      return;
    }
    let httpRequest = http.createHttp();
    const amapKey = 'd4552bc3e20af2857f9cfd5ac95ded1d';
    try {
      let url = `https://restapi.amap.com/v3/place/text?keywords=${encodeURIComponent(keyword)}&city=${encodeURIComponent(this.currentCity)}&offset=10&page=1&key=${amapKey}`;
      let response = await httpRequest.request(url);
      if (response.responseCode === 200) {
        let res = JSON.parse(response.result as string) as AmapResponse;
        if (res.status === '1' && res.pois) {
          this.searchResults = res.pois;
        }
      }
    } catch (err) {
      console.error('POI_Search_Error: ' + JSON.stringify(err));
    } finally {
      httpRequest.destroy();
    }
  }

  // --- 2. å®Œå–„åçš„å¹³å°é€‰æ‹©å”¤èµ·é€»è¾‘ ---
  openPicker(mode: string) {
    this.currentMode = mode;
    // æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆ†é…å¹³å°
    if (mode === 'taxi') {
      this.activePlatforms = ['é«˜å¾·', 'ç™¾åº¦', 'è…¾è®¯', 'æ»´æ»´'];
    } else if (mode === 'rent') {
      this.activePlatforms = ['æºç¨‹ç§Ÿè½¦', 'å“ˆå•°ç§Ÿè½¦', 'ç¥å·ç§Ÿè½¦'];
    } else if (mode === 'bike') {
      this.activePlatforms = ['ç¾å›¢', 'å“ˆå•°', 'å¾®ä¿¡', 'æ”¯ä»˜å®'];
    } else if (mode === 'bus') {
      this.activePlatforms = ['å¾®ä¿¡', 'æ”¯ä»˜å®'];
    }
    this.isShowPlatforms = true;
  }

  // --- 3. æ ¸å¿ƒè·³è½¬å‡½æ•° ---
  doJump(platform: string) {
    let uri = '';
    const city = this.currentCity.replace('å¸‚', '');
    const dest = this.destination;

    if (this.currentMode === 'taxi' || this.currentMode === 'bus') {
      if (!dest) {
        promptAction.showToast({ message: 'è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©ç›®çš„åœ°' });
        return;
      }
      if (platform === 'é«˜å¾·') uri = `amapuri://route/plan/?dname=${encodeURIComponent(city + dest)}&dev=0&t=0`;
      // ... å…¶ä»– scheme é€»è¾‘
    } else if (this.currentMode === 'bike') {
      if (platform === 'å¾®ä¿¡') uri = 'weixin://dl/scan';
      // ... å…¶ä»– scheme é€»è¾‘
    }

    this.isShowPlatforms = false;
    promptAction.showToast({ message: `æ­£åœ¨å”¤èµ· ${platform}...` });
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯å±‚ï¼šç‚¹å‡»æ­¤å¤„å…³é—­æœç´¢é¢„æµ‹å’Œå¹³å°å¼¹çª—
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#F4F6F8')
        .onClick(() => {
          this.searchResults = [];
          this.isShowPlatforms = false;
        })

      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(24).onClick(() => router.back())
          Text('æ–‡æ—…åŠ©æ‰‹').fontSize(20).fontWeight(FontWeight.Bold).margin({ left: 12 })
          Blank()
          Text(this.currentCity).fontSize(14).fontColor('#666')
        }
        .width('100%').padding(16).backgroundColor(Color.White)

        Tabs({ index: this.selectedIndex }) {
          TabContent() { this.TicketModule() }.tabBar('ğŸ« é—¨ç¥¨')
          TabContent() { this.HotelModule() }.tabBar('ğŸ¨ é…’åº—')
          TabContent() { this.TrafficModule() }.tabBar('ğŸš— äº¤é€š')
        }
        .barMode(BarMode.Fixed)
        .onChange(index => this.selectedIndex = index)
      }
      .width('100%').height('100%')

      // 4. æœç´¢é¢„æµ‹æµ®å±‚ (é€šè¿‡ Stack å±‚çº§æµ®åœ¨æœ€ä¸Š)
      if (this.searchResults.length > 0) {
        this.SuggestionOverlay()
      }

      // 5. å¹³å°é€‰æ‹©åº•é¢æ¿
      if (this.isShowPlatforms) {
        this.PlatformPicker()
      }
    }
  }

  // --- äº¤é€šæ¨¡å— UI ---
  @Builder TrafficModule() {
    Scroll() {
      Column({ space: 24 }) {
        Column({ space: 8 }) {
          Text('ä½ è¦å»å“ªå„¿ï¼Ÿ').fontSize(32).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
          Text(`åœ¨${this.currentCity}äº«å—æ™ºæ…§å‡ºè¡Œ`).fontSize(14).fontColor('#999')
        }.alignItems(HorizontalAlign.Start).width('100%')

        // æœç´¢æ¡†
        Search({ placeholder: 'è¾“å…¥ç›®çš„åœ°ï¼Œä¸€é”®å¤šå¹³å°æ¯”ä»·...', value: this.destination })
          .height(56)
          .backgroundColor(Color.White)
          .borderRadius(16)
          .border({ width: 1, color: '#F0F0F0' })
          .onChange(v => {
            this.destination = v;
            this.searchPoi(v);
          })

        // åŠŸèƒ½çŸ©é˜µï¼ˆéå¯¹ç§°å·¦å¯¹é½å¸ƒå±€ï¼‰
        this.SectionTitle('æ‰“è½¦/å¯¼èˆª (è‡ªåŠ¨å¡«å……)')
        this.TrafficGrid(['é«˜å¾·', 'ç™¾åº¦', 'è…¾è®¯', 'æ»´æ»´'], 'taxi', '#FF9500')

        this.SectionTitle('ç§Ÿè½¦è‡ªé©¾ (è‡ªç”±æ¢ç´¢)')
        this.TrafficGrid(['æºç¨‹ç§Ÿè½¦', 'å“ˆå•°ç§Ÿè½¦', 'ç¥å·ç§Ÿè½¦'], 'rent', '#4CD964')

        this.SectionTitle('ä½ç¢³å‡ºè¡Œ (ç›´æ¥æ‰«ç )')
        this.TrafficGrid(['ç¾å›¢', 'å“ˆå•°', 'å¾®ä¿¡', 'æ”¯ä»˜å®'], 'bike', '#007DFF')

      }.padding(20).alignItems(HorizontalAlign.Start)
    }.scrollBar(BarState.Off)
  }

  @Builder SuggestionOverlay() {
    Column() {
      ForEach(this.searchResults, (poi: AmapPoi) => {
        Row() {
          SymbolGlyph($r('sys.symbol.map')).fontSize(18).fontColor(['#CCC'])
          Column() {
            Text(poi.name).fontSize(15).fontWeight(FontWeight.Medium)
            Text(poi.address).fontSize(11).fontColor('#999').maxLines(1).textOverflow({overflow: TextOverflow.Ellipsis})
          }.alignItems(HorizontalAlign.Start).margin({ left: 12 }).layoutWeight(1)
        }
        .width('100%').padding(16).border({ width: { bottom: 0.5 }, color: '#F5F5F5' })
        .onClick(() => {
          this.destination = poi.name;
          this.searchResults = [];
          this.openPicker('taxi');
        })
      })
    }
    .width('92%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 30, color: '#20000000' })
    .position({ x: '4%', y: 180 }) // å®šä½åœ¨æœç´¢æ¡†ä¸‹æ–¹
    .zIndex(100)
  }

  @Builder SectionTitle(title: string) {
    Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
  }

  @Builder TrafficGrid(platforms: string[], mode: string, color: string) {
    Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
      ForEach(platforms, (name: string) => {
        Column() {
          Circle({ width: 48, height: 48 }).fill(color + '15')
            .overlay(this.IconText(name[0], color), { align: Alignment.Center })
          Text(name).fontSize(12).margin({ top: 8 }).fontColor('#444')
        }
        .width('22%').margin({ bottom: 16, right: '3%' })
        .onClick(() => this.openPicker(mode))
      })
    }
  }

  @Builder PlatformPicker() {
    Stack({ alignContent: Alignment.Bottom }) {
      // é®ç½©å±‚
      Rect().fill('#80000000').width('100%').height('100%').onClick(() => this.isShowPlatforms = false)

      // å¼¹çª—æŠ½å±‰
      Column() {
        Text('é€‰æ‹©å‡ºå‘å¹³å°').fontSize(18).fontWeight(FontWeight.Bold).margin({ bottom: 24 })
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceAround }) {
          ForEach(this.activePlatforms, (p: string) => {
            Column() {
              Circle({ width: 56, height: 56 }).fill('#F5F7FA')
                .overlay(this.IconText(p[0], '#1A1A1A'), { align: Alignment.Center })
              Text(p).fontSize(12).margin({ top: 10 })
            }.onClick(() => this.doJump(p))
          })
        }
        Button('å–æ¶ˆ').margin({ top: 32 }).width('100%').backgroundColor('#F5F5F5').fontColor('#666')
          .onClick(() => this.isShowPlatforms = false)
      }
      .padding(24).backgroundColor(Color.White).borderRadius({ topLeft: 24, topRight: 24 })
    }.width('100%').height('100%').zIndex(200)
  }

  @Builder IconText(char: string, color: string) {
    Text(char).fontColor(color).fontWeight(FontWeight.Bold).fontSize(18)
  }

  // é—¨ç¥¨ä¸é…’åº—ä¿æŒåŸé€»è¾‘
  @Builder TicketModule() { /* ... */ }
  @Builder HotelModule() { /* ... */ }
}