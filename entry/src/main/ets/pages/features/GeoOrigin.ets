import { router } from '@kit.ArkUI';
import { http } from '@kit.NetworkKit'; // ÂØºÂÖ•ÂéüÁîüÁΩëÁªúÂ∫ì
import { BusinessError } from '@kit.BasicServicesKit';
import { GEO_ORIGIN_DATA, CityStory, DistrictStory } from '../../models/DistrictStoryData';

/* ===== Êô∫Ë∞± GLM ÂìçÂ∫îÁªìÊûÑÔºàÊúÄÂ∞èÂèØÁî®ÁâàÔºâ ===== */
interface GLMMessage {
  role: string;
  content: string;
}

interface GLMChoice {
  message: GLMMessage;
}

interface GLMChatResponse {
  choices: GLMChoice[];
}

interface AIChatItem {
  role: 'user' | 'assistant'
  content: string     // ÂÆûÈôÖÂèëÁªô AI ÁöÑÔºàÂê´ PromptÔºâ
  display?: string    // ‚≠ê ÁïåÈù¢ÊòæÁ§∫ÁöÑÊñáÂ≠óÔºàÁ∫ØÈóÆÈ¢òÔºâ
}


@Entry
@Component
struct GeoOriginNewView {
  @StorageLink('currentCity') currentCity: string = 'Ê≠¶Ê±â';
  @State selectedDistrict: DistrictStory | null = null;
  @State isShowDetail: boolean = false;

  /* ========= AI Èù¢Êùø ========= */
  @State aiChats: AIChatItem[] = []   // ‚≠ê Â§öËΩÆÂØπËØùÊ†∏ÂøÉ
  @State showAI: boolean = false;       // AI Èù¢ÊùøÊòØÂê¶ÊòæÁ§∫
  @State aiQuery: string = '';          // Áî®Êà∑ËæìÂÖ•
  @State aiLoading: boolean = false;    // AI Ë∞ÉÁî®‰∏≠

  /* ========= ÂÅèÂéÜÂè≤Ëâ≤Êùø ========= */
  private bgDeep = '#3A352F';
  private accentAmber = '#C9A25D';
  private cardBg = 'rgba(255,255,255,0.05)';
  private dividerDark = 'rgba(255,255,255,0.12)';
  private paperBg = '#24211C';

  private getCityData(): CityStory {
    return GEO_ORIGIN_DATA[this.currentCity] || {
      cityName: this.currentCity,
      summary: 'Ê≠£Âú®Ë∞ÉÂèñËØ•ÂüéÂ∏ÇÁöÑÂú∞ÂêçÁºñÂπ¥Ê°£Ê°à...',
      districts: []
    };
  }

  // ‚≠ê API Key ÂÆâÂÖ®Â§ÑÁêÜÔºöÊãÜÂàÜÂ≠òÂÇ®ÔºåÈò≤Ê≠¢ÊòéÊñáÁõ¥Êé•Êö¥Èú≤
  private getGlmToken(): string {
    const partA = '82e4d46a05264dd19a27e1d91b30dce6';
    const partB = 'e1d91b30dce6';
    const partC = 'UNpMhFWNznhFSPLo';
    return `${partA}.${partB}.${partC}`;
  }

  private GLM_MODEL = 'glm-4-flash';        // Âø´ + ÂÖçË¥πÈ¢ùÂ∫¶ + Á®≥ÂÆö
  private aiScroller: Scroller = new Scroller();

  private buildArchivePrompt(userQuestion: string): string {
    const city = this.currentCity;
    const district = this.selectedDistrict?.name ?? '';

    return `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏≠ÂõΩÂéÜÂè≤Âú∞Âêç‰∏éÂú∞ÊñπÂøóÁ†îÁ©∂‰∏ìÂÆ∂„ÄÇ„ÄêÁ†îÁ©∂ËÉåÊôØ„ÄëÂüéÂ∏ÇÔºö${city}ÔºåÂú∞ÂêçÔºö${district || 'Êú™ÊåáÂÆö'}„ÄÇ„ÄêÂõûÁ≠îË¶ÅÊ±Ç„Äë1. ‰ΩøÁî®Ê≠£Âºè„ÄÅÂÖãÂà∂„ÄÅÂÅèÂè≤ÊñôÁöÑËØ≠Ê∞î 2. ‰ºòÂÖà‰ªéÂéÜÂè≤Ê≤øÈù©„ÄÅÂêçÁß∞Êù•Ê∫ê„ÄÅË°åÊîøÂèòËøÅËßíÂ∫¶Ëß£Èáä 3. Â¶ÇÂ≠òÂú®Â§öÁßçËØ¥Ê≥ïÔºåËØ∑ËØ¥Êòé‚ÄúÂÖ∂‰∏Ä / ÂÖ∂‰∫å‚Äù 4. ‰∏çË¶Å‰ΩøÁî®Âè£ËØ≠Ôºå‰∏çË¶ÅÁºñÈÄ†ÂÖ∑‰ΩìÂπ¥‰ª£ 5. Â≠óÊï∞ÊéßÂà∂Âú® 200 Â≠ó‰ª•ÂÜÖ„ÄÇ„ÄêÁî®Êà∑ÈóÆÈ¢ò„Äë${userQuestion}`;
  }

  /* ================= Ë∞ÉÁî® Êô∫Ë∞± GLM API ================= */
  private async callAI(question: string) {
    if (!question) return;

    // 1Ô∏è‚É£ ÊûÑÈÄ† Prompt ÈÄªËæëÔºàÂ≠òÂÖ• contentÔºå‰ΩÜ UI ‰∏çÊòæÁ§∫Ôºâ
    const userContent = this.buildArchivePrompt(question);

    // 2Ô∏è‚É£ ËÆ∞ÂΩïÂØπËØùÔºöÂæÆ‰ø°ÂºèËÅäÂ§©‰ΩìÈ™å
    this.aiChats.push({
      role: 'user',
      content: userContent,
      display: question // ‚≠ê UI Âè™ÊòæÁ§∫ËøôË°åÂéüÂßãËæìÂÖ•
    });

    this.aiLoading = true;
    this.aiQuery = ''; // Á´ãÂç≥Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂÆûÁé∞ÂèçÈ¶à

    // ÂèëÈÄÅÂêéÁ´ãÂç≥ÊªöÂä®Âà∞Â∫ïÈÉ®
    this.scrollToBottom();

    let httpRequest = http.createHttp();

    try {
      const response = await httpRequest.request(
        'https://open.bigmodel.cn/api/paas/v4/chat/completions',
        {
          method: http.RequestMethod.POST,
          header: {
            'Authorization': `Bearer ${this.getGlmToken()}`,
            'Content-Type': 'application/json'
          },
          extraData: {
            model: this.GLM_MODEL,
            messages: [
              {
                role: 'system',
                content: `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏≠ÂõΩÂéÜÂè≤Âú∞Âêç‰∏éÂú∞ÊñπÂøóÁ†îÁ©∂‰∏ìÂÆ∂„ÄÇÂüéÂ∏ÇÔºö${this.currentCity}ÔºåÂú∞ÂêçÔºö${this.selectedDistrict?.name ?? 'Êú™ÊåáÂÆö'}„ÄÇËØ∑‰∏•Ê†ºÈÅµÂæ™Ê≠£ÂºèÂè≤ÊñôËØ≠Ê∞î„ÄÇ`
              },
              ...this.aiChats.slice(-6).map(item => ({
                role: item.role,
                content: item.content
              } as GLMMessage))
            ],
            temperature: 0.3
          },
          expectDataType: http.HttpDataType.OBJECT,
          connectTimeout: 15000,
          readTimeout: 15000
        }
      );

      if (response.responseCode === 200) {
        const result = response.result as GLMChatResponse;
        const answer = result.choices?.[0]?.message?.content ?? 'AI Êú™ËøîÂõûÊúâÊïàÂÜÖÂÆπ';

        this.aiChats.push({
          role: 'assistant',
          content: answer
        });
        this.scrollToBottom();
      } else {
        this.aiChats.push({
          role: 'assistant',
          content: `ËØ∑Ê±ÇÂ§±Ë¥•ÔºàÁä∂ÊÄÅÁ†Å ${response.responseCode}Ôºâ`
        })
      }
    } catch (err) {
      const error = err as BusinessError;
      this.aiChats.push({
        role: 'assistant',
        content: `ËøûÊé•Â§±Ë¥•Ôºö${error.message}`
      })
    } finally {
      httpRequest.destroy();
      this.aiLoading = false;
    }
  }

  // ‚≠ê Ëß£ÂÜ≥ÊªöÂä®Âà∞Â∫ïÈÉ®ÁöÑÈóÆÈ¢ò
  private scrollToBottom() {
    setTimeout(() => {
      this.aiScroller.scrollEdge(Edge.Bottom);
    }, 150);
  }

  build() {
    Stack() {
      /* ========= ËÉåÊôØ ========= */
      Stack() {
        Circle().width(420).height(420).fill('#6B6459').blur(140).position({ x: -120, y: -80 })
        Circle().width(360).height(360).fill('#8A7A5E').blur(120).position({ x: '55%', y: '35%' })
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.bgDeep)

      /* ========= ‰∏ª‰Ωì ========= */
      Column() {
        this.ModernNav()

        Scroll() {
          Column() {
            this.CityHeroHeader()
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
              ForEach(this.getCityData().districts, (item: DistrictStory, index: number) => {
                this.ArtisticCard(item, index)
              })
            }.padding({ left: 16, right: 16, top: 30, bottom: 40 })
          }.width('100%')
        }.layoutWeight(1).edgeEffect(EdgeEffect.Spring)
      }
      .opacity(this.isShowDetail || this.showAI ? 0.35 : 1)
      .scale(this.isShowDetail || this.showAI ? { x: 0.98, y: 0.98 } : { x: 1, y: 1 })

      /* ========= ËØ¶ÊÉÖÈ°µ ========= */
      if (this.isShowDetail && this.selectedDistrict) this.SmartDetailOverlay()

      /* ========= AI Èù¢Êùø ========= */
      if (this.showAI) {
        Stack({ alignContent: Alignment.Bottom }) {
          // ÈÅÆÁΩ©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.45)')
            .onClick(() => {
              animateTo(
                { duration: 260, curve: Curve.EaseIn },
                () => this.showAI = false
              )
            })

          this.AIPanel()
        }
      }
    }
    .width('100%')
    .height('100%')
  }

  /* ================= È°∂ÈÉ®ÂØºËà™ ================= */
  @Builder ModernNav() {
    Row() {
      SymbolGlyph($r('sys.symbol.chevron_left'))
        .fontSize(24)
        .fontColor(['rgba(255,255,255,0.9)'])
        .onClick(() => router.back())

      Blank()

      Text('AI ARCHIVE')
        .fontSize(10)
        .fontColor(this.accentAmber)
        .fontWeight(FontWeight.Bold)
        .letterSpacing(1)
        .padding({ left: 12, right: 12, top: 4, bottom: 4 })
        .borderRadius(20)
        .border({ width: 1, color: 'rgba(201,162,93,0.6)' })
        .onClick(() => {
          animateTo(
            { duration: 360, curve: Curve.EaseOut },
            () => {
              this.showAI = true;
              this.aiQuery = '';
            }
          )
        })
    }.width('100%').padding({ left: 20, right: 20, top: 40, bottom: 10 })
  }

  @Builder
  AIPanel() {
    Column() {
      /* ===== È°∂ÈÉ®Ê†è ===== */
      Row() {
        Text('AI Âú∞ÂêçÊ°£Ê°à')
          .fontSize(18)
          .fontWeight(FontWeight.Bolder)
          .fontColor(this.accentAmber)
        Blank()
        SymbolGlyph($r('sys.symbol.xmark'))
          .fontSize(20)
          .fontColor([this.accentAmber])
          .onClick(() => {
            animateTo(
              { duration: 260, curve: Curve.EaseIn },
              () => this.showAI = false
            )
          })
      }
      .padding(16)
      .backgroundColor(this.paperBg)
      .borderRadius({ topLeft: 18, topRight: 18 })

      /* ===== ÂØπËØùÂå∫ ===== */
      Scroll(this.aiScroller) {
        Column({ space: 14 }) {
          ForEach(this.aiChats, (item: AIChatItem) => {
            Row() {
              if (item.role === 'assistant') {
                Column() {
                  Text(item.content)
                    .fontSize(15)
                    .lineHeight(26)
                    .fontColor('rgba(255,255,255,0.88)')
                }
                .padding(14)
                .backgroundColor('rgba(255,255,255,0.08)')
                .borderRadius(14)
              } else {
                Blank()
                Column() {
                  // ‚≠ê ‰øÆÊ≠£ÊòæÁ§∫ÈÄªËæëÔºöÂæÆ‰ø°ËÅäÂ§©Âºè‰ΩìÈ™åÔºåÂè™ÁúãÁÆÄÁü≠ÈóÆÈ¢ò
                  Text(item.display ?? item.content)
                    .fontSize(15)
                    .lineHeight(24)
                    .fontColor(this.bgDeep)
                }
                .padding(14)
                .backgroundColor(this.accentAmber)
                .borderRadius(14)
              }
            }.width('100%')
          })

          if (this.aiLoading) {
            Row({ space: 8 }) {
              // ‚≠ê Ê∑ªÂä†ËΩ¨ÂúàÂúàÂä®Áîª
              LoadingProgress().width(24).height(24).color(this.accentAmber)
              Text('Ê≠£Âú®Êü•ÈòÖÂú∞ÊñπÂøó‚Ä¶')
                .fontSize(13)
                .fontColor(this.accentAmber)
                .opacity(0.8)
            }.margin({ top: 10 })
          }
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor(this.paperBg)

      /* ===== ËæìÂÖ•Âå∫ ===== */
      Row({ space: 10 }) {
        TextInput({ text: this.aiQuery, placeholder: 'ËØ¢ÈóÆÂú∞ÂêçÊ≤øÈù©‚Ä¶' })
          .layoutWeight(1)
          .height(44)
          .backgroundColor('rgba(255,255,255,0.12)')
          .fontColor(Color.White)
          .placeholderColor('rgba(255,255,255,0.35)')
          .enterKeyType(EnterKeyType.Send) // ‚≠ê ËΩØÈîÆÁõòÊîπ‰∏∫ÂèëÈÄÅÈîÆÂèçÈ¶à
          .onChange(v => this.aiQuery = v)
          .onSubmit(() => {
            if (this.aiQuery.trim()) this.callAI(this.aiQuery.trim());
          })

        Button('ÂèëÈÄÅ')
          .height(44)
          .backgroundColor(this.accentAmber)
          .fontColor(this.bgDeep)
          .onClick(() => {
            if (this.aiQuery.trim()) this.callAI(this.aiQuery.trim());
          })
      }
      .padding({ left: 16, right: 16, bottom: 26, top: 10 })
      .backgroundColor(this.paperBg)
    }
    .width('100%')
    .height('65%')
    .alignSelf(ItemAlign.End)
    .transition(TransitionEffect.move(TransitionEdge.BOTTOM))
    .shadow({ radius: 32, color: 'rgba(0,0,0,0.45)' })
  }


  /* ================= ÂüéÂ∏ÇÂ§¥ÈÉ® ================= */
  @Builder
  CityHeroHeader() {
    Column() {
      Row() {
        Rect({ width: 3, height: 48 })
          .fill(this.accentAmber)
          .margin({ right: 16 })

        Column() {
          Text(this.getCityData().cityName)
            .fontSize(56)
            .fontWeight(FontWeight.Bolder)
            .fontColor('rgba(255,255,255,0.95)')
            .letterSpacing(2)

          Text('Êï∞Â≠óÂåñÂú∞ÂêçÊ∫ØÊ∫ê')
            .fontSize(12)
            .fontColor(this.accentAmber)
            .letterSpacing(4)
        }
        .alignItems(HorizontalAlign.Start)
      }

      Text(this.getCityData().summary)
        .fontSize(15)
        .fontColor('rgba(255,255,255,0.8)')
        .lineHeight(26)
        .margin({ top: 30 })
        .width('90%')
        .textAlign(TextAlign.JUSTIFY)
    }
    .padding({ left: 24, top: 30, right: 24 })
  }

  /* ================= Âç°Áâá ================= */
  @Builder
  ArtisticCard(item: DistrictStory, index: number) {
    Column({ space: 14 }) {
      /* Ê°£Ê°àÁºñÂè∑ÔºàÂº±Â≠òÂú®Ôºâ */
      Text(`Âú∞ÂêçÊù°ÁõÆ ${index + 1}`)
        .fontSize(11)
        .fontColor('rgba(255,255,255,0.35)')
        .letterSpacing(2)

      /* Âú∞Âêç ‚Äî‚Äî ‰∏ªËßÜËßâ */
      Text(item.name)
        .fontSize(index % 3 == 0 ? 34 : 28) // üî• ÊòéÊòæÊîæÂ§ß
        .fontWeight(FontWeight.Bolder)
        .fontColor('rgba(255,255,255,0.92)')
        .letterSpacing(2)
        .maxLines(2)

      /* Ê≥®Èáä / Âà´Áß∞ / Ê¶ÇËø∞ */
      Text(item.slogan)
        .fontSize(14)
        .fontColor(this.accentAmber)
        .lineHeight(22)
        .maxLines(2)
        .margin({ top: 4 })

      Blank()

      /* Â∫ïÈÉ®ÁªÜÁ∫øÔºåÂÉè‰π¶È°µÂàÜÈöî */
      Rect()
        .width(40)
        .height(1)
        .fill('rgba(255,255,255,0.18)')
    }
    .width(index % 3 == 0 ? '100%' : '48%')
    .height(index % 3 == 0 ? 200 : 220) // üî• ÂÜÖÂÆπÈ´òÂ∫¶ÂêåÊ≠•Âä†Â§ß
    .padding(24)
    .margin({ bottom: 18 })
    .backgroundColor(this.cardBg)
    .borderRadius(22)
    .scale({ x: 0.96, y: 0.96 })
    .opacity(0.98)
    .border({ width: 1, color: this.dividerDark })
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Start)
    .onClick(() => {
      this.selectedDistrict = item;
      // Ëá™Âä®Âú® AI Èù¢ÊùøÂä†ÂÖ•Âú∞Âêç‰∏ä‰∏ãÊñá
      this.aiChats.push({
        role: 'assistant',
        content: `Â∑≤ËøõÂÖ•„Äê${item.name}„ÄëÂú∞ÂêçÊ°£Ê°àÔºåÂèØÁªßÁª≠ËØ¢ÈóÆÂÖ∂Ê≤øÈù©„ÄÇ`
      });

      animateTo(
        { duration: 380, curve: Curve.EaseOut },
        () => {
          this.isShowDetail = true
        }
      );
    })
  }

  /* ================= ËØ¶ÊÉÖË¶ÜÁõñÂ±Ç ================= */
  @Builder
  SmartDetailOverlay() {
    Stack({ alignContent: Alignment.Bottom }) {
      /* ËÉåÊôØÂéãÊöó */
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(30,26,20,0.75)')
        .onClick(() => {
          animateTo(
            { duration: 260, curve: Curve.EaseIn },
            () => {
              this.isShowDetail = false
            }
          )
        })

      /* ÊñáÁåÆÈ°µ */
      Column() {
        /* Á∫∏È°µÈ°∂ÈÉ®Ë£ÖËÆ¢ÊÑü */
        Rect()
          .width(60)
          .height(4)
          .fill('rgba(0,0,0,0.25)')
          .borderRadius(2)
          .margin({ top: 12, bottom: 24 })

        Scroll() {
          Column({ space: 30 }) {
            /* Ê†áÈ¢òÂå∫ */
            Column({ space: 12 }) {
              Text(this.selectedDistrict?.name)
                .fontSize(42)
                .fontWeight(FontWeight.Bolder)
                .fontColor('rgba(255,255,255,0.95)')
                .letterSpacing(3)

              Text('Âú∞ÂêçÊ≤øÈù©ËÆ∞ËΩΩ')
                .fontSize(13)
                .fontColor(this.accentAmber)
                .letterSpacing(4)

              Rect()
                .width(80)
                .height(1)
                .fill(this.accentAmber)
            }

            /* Ê≠£Êñá */
            Text(
              `${this.selectedDistrict?.origin ?? ''}\n\n${this.selectedDistrict?.history ?? ''}`
            )
              .fontSize(16)
              .fontColor('rgba(255,255,255,0.75)')
              .lineHeight(30)
              .letterSpacing(1)

            /* Ê≥®ËÆ∞ */
            Text('‚Äî‚Äî ÊëòÂΩïËá™Âú∞ÊñπÂøó‰∏éÂéÜÂè≤ÊñáÁåÆ')
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.35)')
              .margin({ top: 20 })
          }
          .padding({ left: 26, right: 26, bottom: 40 })
        }
      }
      .width('100%')
      .height('78%')
      .backgroundColor(this.paperBg)
      .borderRadius({ topLeft: 28, topRight: 28 })
    }
  }

  /* ================= Ê≠£ÊñáÂå∫Âùó ================= */
  @Builder
  DetailSection(title: string, content: string | undefined) {
    Column({ space: 16 }) {
      Row({ space: 8 }) {
        Circle({ width: 6, height: 6 })
          .fill(this.accentAmber)

        Text(title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2B261F')
          .letterSpacing(1)
      }

      Text(content)
        .lineHeight(30)
        .fontSize(16)
        .fontColor('#3A342C')
        .textAlign(TextAlign.JUSTIFY)
    }
    .alignItems(HorizontalAlign.Start)
  }
}
