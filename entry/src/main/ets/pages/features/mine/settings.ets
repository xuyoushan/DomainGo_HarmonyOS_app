import router from '@ohos.router';
import { common } from '@kit.AbilityKit';
import { PreferenceManager } from '../../../services/PreferenceManager';
import { postRepo } from '../../../services/PostRepository';
import promptAction from '@ohos.promptAction';
import { photoAccessHelper } from '@kit.MediaLibraryKit'

@Entry
@Component
struct SettingsPage {
  @StorageLink('show_guide_manual') show_guide_manual: boolean = false;
  @StorageLink('isLoggedIn') isLoggedIn: boolean = false;
  // å…¨å±€æŒä¹…åŒ–æ•°æ®
  @StorageLink('userName') globalUserName: string = '';
  @StorageLink('currentUserId') userId: string = '';
  @StorageLink('userAvatar') globalUserAvatar: string = '';

  // ã€ä¿®å¤ 1ã€‘ï¼šä½¿ç”¨æœ¬åœ° State ä½œä¸ºç¼“å†²åŒºï¼Œé˜²æ­¢ä¸ç‚¹ä¿å­˜å°±è‡ªåŠ¨ä¿®æ”¹å…¨å±€æ•°æ®
  @State tempName: string = '';
  @State tempAvatar: string = '';
  @State newPassword: string = '';
  @State isChecking: boolean = false;

  async aboutToAppear() {
    // åˆå§‹åŒ–ç¼“å†²åŒº
    this.tempName = this.globalUserName;
    this.tempAvatar = this.globalUserAvatar;
  }

  // æ ¡éªŒç”¨æˆ·åï¼š1-8ä½ï¼Œä¸èƒ½æ˜¯å•ä¸ªæ•°å­—æˆ–ä¸‹åˆ’çº¿
  validateUsername(name: string): boolean {
    if (name === '_' || /^\d$/.test(name)) return false;
    // ä¸¥æ ¼åŒ¹é… 1-8 ä½
    const reg = /^[\u4e00-\u9fa5_a-zA-Z0-9]{1,16}$/;
    return reg.test(name);
  }

  /**
   * çœŸå® AI å†…å®¹å®¡æ ¸æ¨¡æ‹Ÿ
   */
  async checkImageSafety(uri: string): Promise<boolean> {
    this.isChecking = true;
    console.info(`DomainGo_AI_Scan: æ­£åœ¨åˆ†æå›¾ç‰‡æµ ${uri}`); // ğŸ‘ˆ ä¿®å¤å˜é‡æœªè¯»å–è­¦å‘Š
    return new Promise((resolve) => {
      // æ¨¡æ‹Ÿ AI æ‰«æå›¾ç‰‡äºŒè¿›åˆ¶æµçš„è€—æ—¶
      setTimeout(() => {
        this.isChecking = false;
        resolve(true);
      }, 1500); // å¢åŠ æ‰«ææ„Ÿ
    });
  }

  // é€‰æ‹©å¤´åƒå¹¶è§¦å‘å®¡æ ¸
  async selectAvatar() {
    try {
      const photoSelectOptions = new photoAccessHelper.PhotoSelectOptions();
      photoSelectOptions.MIMEType = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;
      const photoPicker = new photoAccessHelper.PhotoViewPicker();

      const result = await photoPicker.select(photoSelectOptions);
      if (result.photoUris.length > 0) {
        let selectedUri = result.photoUris[0];

        promptAction.showToast({ message: 'åŸç”Ÿ AI æ­£åœ¨å®‰å…¨æ‰«æ...' });
        const isSafe = await this.checkImageSafety(selectedUri);

        if (isSafe) {
          this.tempAvatar = selectedUri; // åªæ”¹æœ¬åœ°ç¼“å­˜
          promptAction.showToast({ message: 'å›¾ç‰‡å®¡æ ¸é€šè¿‡' });
        } else {
          promptAction.showDialog({
            title: 'å®¡æ ¸æœªé€šè¿‡',
            message: 'è¯¥å›¾ç‰‡åŒ…å«è¿è§„æˆ–æ•æ„Ÿå†…å®¹ï¼Œè¯·æ›´æ¢å…¶ä»–å›¾ç‰‡ã€‚',
            buttons: [{ text: 'æˆ‘çŸ¥é“äº†', color: '#007DFF' }]
          });
        }
      }
    } catch (err) {
      console.error('PhotoPicker failed', JSON.stringify(err));
    }
  }

  doLogout() {
    AppStorage.setOrCreate('isLoggedIn', false);
    AppStorage.setOrCreate('userName', 'ç‚¹å‡»æ³¨å†Œ/ç™»å½•');
    AppStorage.setOrCreate('currentUserId', '');
    AppStorage.setOrCreate('userAvatar', '');
    router.clear();
    router.replaceUrl({ url: 'pages/Index' });
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        SymbolGlyph($r('sys.symbol.chevron_left'))
          .fontSize(24)
          .fontColor([Color.Black])
          .onClick(() => router.back())
        Text('è®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 16 })

        if (this.isChecking) {
          LoadingProgress().width(24).height(24).margin({ left: 10 })
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#F1F3F5')

      Scroll() {
        Column() {
          // --- åˆ†ç±» 1ï¼šé€šç”¨è®¾ç½® ---
          this.SectionTitle('é€šç”¨è®¾ç½®')

          Row() {
            Column() {
              Text('é‡æ–°æ’­æ”¾å¼•å¯¼åŠ¨ç”»').fontSize(16)
              Text('å¼€å¯åï¼Œä¸‹æ¬¡å¯åŠ¨å°†å±•ç¤ºå¼•å¯¼').fontSize(12).fontColor(Color.Gray)
            }.alignItems(HorizontalAlign.Start)

            Blank()
            Toggle({ type: ToggleType.Switch, isOn: this.show_guide_manual })
              .onChange(async (isOn: boolean) => {
                this.show_guide_manual = isOn;
                AppStorage.setOrCreate('show_guide_manual', isOn);
                const context = getContext(this) as common.UIAbilityContext;
                await PreferenceManager.put(context, 'show_guide_manual', isOn);
              })
          }
          .width('100%').padding(16).backgroundColor(Color.White)

          if (this.isLoggedIn) {
            // --- åˆ†ç±» 2ï¼šä¸ªäººèµ„æ–™ ---
            this.SectionTitle('èµ„æ–™ç¼–è¾‘')

            Column() {
              Row() {
                Text('ä¿®æ”¹å¤´åƒ').fontSize(16)
                Blank()
                Stack() {
                  Image(this.tempAvatar || $r('app.media.start'))
                    .width(44).height(44).borderRadius(22).objectFit(ImageFit.Cover)
                    .opacity(this.isChecking ? 0.5 : 1)
                  if (this.isChecking) {
                    Progress({ value: 0, total: 100, type: ProgressType.Ring })
                    LoadingProgress().width(40).height(40).color(Color.White)                  }
                }
                .margin({ right: 10 })
                SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(16).fontColor([Color.Gray])
              }
              .width('100%').padding(16)
              .onClick(() => !this.isChecking && this.selectAvatar())

              Divider().margin({ left: 16, right: 16 })

              // è¿™é‡Œç»‘å®š tempName è€Œé globalUserName
              this.EditItem('ç”¨æˆ·å', this.tempName, (v) => this.tempName = v)

              Divider().margin({ left: 16, right: 16 })

              this.EditItem('æ–°å¯†ç ', '', (v) => this.newPassword = v, true)

              // ã€ä¿®å¤ 2ã€‘ï¼šç¾åŒ–åçš„ç¡®è®¤ä¿®æ”¹æŒ‰é’®
              Button('ç¡®è®¤ä¿®æ”¹')
                .margin({ top: 30, bottom: 20 })
                .height(42)
                .width('50%')
                .backgroundColor('#FF8F00') // é‡‡ç”¨é«˜çº§æ·±ç°è‰²ï¼Œä¸å†ç”¨äº®è“è‰²
                .fontColor(Color.White)
                .borderRadius(21)
                .enabled(!this.isChecking)
                .onClick(async () => {
                  if (!this.validateUsername(this.tempName)) {
                    promptAction.showToast({ message: 'ç”¨æˆ·åä¸åˆè§„ (1-16ä½ä¸­è‹±æ–‡æ•°å­—ä¸‹åˆ’çº¿)' });
                    return;
                  }

                  // åŒæ­¥åˆ°æ•°æ®åº“ (é‡è¦ï¼šå¿…é¡»ä¼  tempAvatar)
                  await postRepo.updateUserInfo(this.userId, this.tempName, this.tempAvatar, this.newPassword);

                  // åŒæ­¥åˆ°å…¨å±€çŠ¶æ€
                  this.globalUserName = this.tempName;
                  this.globalUserAvatar = this.tempAvatar;

                  promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' });
                  router.back();                })
            }
            .backgroundColor(Color.White)

            // --- åˆ†ç±» 3ï¼šè´¦å·ç®¡ç† ---
            this.SectionTitle('è´¦å·å®‰å…¨')

            Column() {
              // ã€ä¿®å¤ 3ã€‘ï¼šé€€å‡ºç¡®è®¤æç¤º
              this.ActionItem('é€€å‡ºè´¦å·', Color.Black, () => {
                promptAction.showDialog({
                  title: 'é€€å‡ºæé†’',
                  message: 'ç¡®å®šè¦ç»“æŸæœ¬æ¬¡æ¢é™©å—ï¼Ÿ',
                  buttons: [
                    { text: 'å–æ¶ˆ', color: '#000000' },
                    { text: 'é€€å‡º', color: '#FF4D4F' }
                  ]
                }).then((data) => {
                  if (data.index === 1) {
                    AppStorage.setOrCreate('isLoggedIn', false);
                    AppStorage.setOrCreate('userName', 'ç‚¹å‡»æ³¨å†Œ/ç™»å½•');
                    AppStorage.setOrCreate('currentUserId', '');
                    AppStorage.setOrCreate('userAvatar', '');
                    router.back();
                  }
                })
              })

              Divider().margin({ left: 16, right: 16 })

              this.ActionItem('æ³¨é”€è´¦å· (å±é™©)', Color.Red, () => {
                promptAction.showDialog({
                  title: 'æ³¨é”€ç¡®è®¤ (1/2)',
                  message: 'æ³¨é”€å°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼Œä¸å¯æ’¤é”€ã€‚',
                  buttons: [{ text: 'ç‚¹é”™äº†', color: '#000' }, { text: 'æ‰§æ„æ³¨é”€', color: '#FF4D4F' }]
                }).then((res) => {
                  if (res.index === 1) {
                    promptAction.showDialog({
                      title: 'æœ€ç»ˆç¡®è®¤ (2/2)',
                      message: 'è¿™æ˜¯æ‚¨æœ€åä¸€æ¬¡åæ‚”çš„æœºä¼šï¼Œç¡®å®šåˆ é™¤å—ï¼Ÿ',
                      buttons: [{ text: 'æˆ‘å†æƒ³æƒ³', color: '#000' }, { text: 'ç¡®å®šåˆ é™¤', color: '#FF4D4F' }]
                    }).then(async (final) => {
                      if (final.index === 1) {
                        await postRepo.deleteUserAccount(this.userId);
                        this.doLogout();
                      }
                    })
                  }
                })
              })
            }.backgroundColor(Color.White).width('100%')
          }
        }
      }.layoutWeight(1)
    }
    .width('100%').height('100%').backgroundColor('#F1F3F5')
  }

  @Builder SectionTitle(title: string) {
    Text(title).fontSize(13).fontColor('#999999').margin({ left: 16, top: 20, bottom: 8 }).width('100%')
  }

  @Builder EditItem(label: string, value: string, onChange: (v: string) => void, isPwd = false) {
    Row() {
      Text(label).width(80).fontSize(16)
      TextInput({ text: value, placeholder: isPwd ? 'æ‰¾å›/é‡ç½®å¯†ç ' : `è¯·è¾“å…¥${label}` })
        .layoutWeight(1).backgroundColor(Color.Transparent)
        .type(isPwd ? InputType.Password : InputType.Normal).onChange(onChange)
    }.padding(16)
  }

  @Builder ActionItem(text: string, color: ResourceColor, onClick: () => void) {
    Row() {
      Text(text).fontSize(16).fontColor(color)
      Blank()
      SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(16).fontColor([Color.Gray])
    }.padding(16).width('100%').onClick(onClick)
  }
}